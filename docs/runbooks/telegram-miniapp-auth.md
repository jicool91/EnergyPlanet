# Telegram Mini App ‚Äî Runbook –ø–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

## –¶–µ–ª–∏

1. –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ `/auth/tma` –∏ `/auth/refresh` —Ä–∞–±–æ—Ç–∞—é—Ç —à—Ç–∞—Ç–Ω–æ: —Ç–æ–∫–µ–Ω—ã —Ä–æ—Ç–∏—Ä—É—é—Ç—Å—è, ¬´—Å–µ–º—å–∏¬ª —Å–µ—Å—Å–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≤–æ–∫—É—é—Ç—Å—è, –ª–∏–º–∏—Ç—ã –Ω–µ –¥—É—à–∞—Ç –ª–µ–≥–∏—Ç–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
2. –ë—ã—Å—Ç—Ä–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã (—Ä–µ–≤–æ–∫–∞—Ü–∏—è refresh-—Ç–æ–∫–µ–Ω–æ–≤, –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ 401/429, –≤—Å–ø–ª–µ—Å–∫–∏ rate-limit).
3. –ó–Ω–∞—Ç—å, –∫–∞–∫–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –Ω—É–∂–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å.

## –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (Railway ‚Üí service `backgame`)

| –ö–ª—é—á | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ |
| --- | --- | --- |
| `TELEGRAM_AUTHDATA_MAX_AGE_SEC` | TTL initData, –≤ —Å–µ–∫—É–Ω–¥–∞—Ö | `86400` |
| `TELEGRAM_ALLOWED_ORIGINS` | –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ origin –¥–ª—è Mini App | `https://t.me[, –≤–∞—à–∏ –¥–æ–º–µ–Ω—ã]` |
| `AUTH_RATE_LIMIT_WINDOW_MS` | –û–∫–Ω–æ rate-limit –¥–ª—è `/auth/*` | `60000` |
| `AUTH_RATE_LIMIT_MAX` | –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∑–∞ –æ–∫–Ω–æ | `8` |
| `SESSION_REFRESH_AUDIT_TTL_DAYS` | –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è `session_refresh_audit` | `30` |

> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å: `railway variables --service backgame --kv`

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ & –º–µ—Ç—Ä–∏–∫–∏

### –ß—Ç–æ –ø–∏—à–µ–º –≤ –ª–æ–≥–∏

- `telegram_auth_data_near_expiry` ‚Äî initData —Å—Ç–∞—Ä—à–µ 20 —á. –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π: –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥.
- `auth_data_expired_renew` ‚Äî –∫–ª–∏–µ–Ω—Ç—É –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Mini App.
- `session_family_revoked` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–Ω—è—Ç–∏–µ —Å–µ–º—å–∏ (–ø—Ä–∏—á–∏–Ω—ã `refresh_*`).
- `auth_rate_limit_triggered` ‚Äî IP —É–ø—ë—Ä—Å—è –≤ –ª–∏–º–∏—Ç. –°–≤–µ—Ä–∏—Ç—å —Å Grafana.

### –ü—Ä–æ–º–µ—Ç–µ–µ–≤—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ (`/metrics`)

| –ú–µ—Ç—Ä–∏–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
| --- | --- |
| `energyplanet_auth_requests_total{endpoint,status,outcome}` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ `/auth/{tma,refresh,telegram}`; outcome=`rate_limited` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ 429 |
| `energyplanet_auth_refresh_audit_total{reason,revocation_reason}` | –°—á—ë—Ç—á–∏–∫ –ø—Ä–∏—á–∏–Ω –≤ `session_refresh_audit` |
| `energyplanet_auth_session_family_revoked_total{trigger}` | –°–∫–æ–ª—å–∫–æ —Å–µ–º–µ–π —Ä–µ–≤–æ–∫–Ω—É–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏/–≤—Ä—É—á–Ω—É—é |

–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä—É—á–Ω—É—é:

```bash
curl -s https://backgame-production.up.railway.app/metrics \
  -u "${PROM_AUTH_USER}:${PROM_AUTH_PASS}" \
  | grep energyplanet_auth
```

–ï—Å–ª–∏ –Ω–µ—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ ‚Üí –º–µ—Ç—Ä–∏–∫–∏ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è (Prometheus —Å–æ–∑–¥–∞—ë—Ç —Å–µ—Ä–∏—é –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–±—ã—Ç–∏—è).

### Grafana/Alertmanager (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ)

1. –î–∞—à–±–æ—Ä–¥: stacked area –ø–æ `energyplanet_auth_requests_total` (—Ä–∞–∑–±–∏–≤–∫–∞ success/error/rate_limited).
2. –î–∞—à–±–æ—Ä–¥: `energyplanet_auth_refresh_audit_total` —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ `reason`.
3. –ê–ª–µ—Ä—Ç: `rate_limited` > 15‚ÄØ% –∑–∞ 5 –º–∏–Ω—É—Ç (–ª–µ–π–±–ª `endpoint='tma'| 'refresh'`).
4. –ê–ª–µ—Ä—Ç: `energyplanet_auth_session_family_revoked_total{trigger!='manual_revoke'}` —Ä–∞—Å—Ç—ë—Ç > 5 —Ä–∞–∑ –∑–∞ 10 –º–∏–Ω—É—Ç.

## –û–ø–µ—Ä–∞—Ü–∏–∏ —Å ¬´—Å–µ–º—å—è–º–∏¬ª —Å–µ—Å—Å–∏–π

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫

```bash
curl -H "Authorization: Bearer <admin access token>" \
  https://backgame-production.up.railway.app/api/v1/admin/auth/session-families?limit=50
```

–û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç `familyId`, `activeSessions`, `lastUsedAt`, `lastIp` –∏ —Ç.–¥.

### –†–µ–≤–æ–∫–∞—Ü–∏—è —Å–µ–º—å–∏ –≤—Ä—É—á–Ω—É—é

```bash
curl -X POST \
  -H "Authorization: Bearer <admin access token>" \
  -H "Content-Type: application/json" \
  -d '{"reason":"support_manual_revoke"}' \
  https://backgame-production.up.railway.app/api/v1/admin/auth/session-families/<FAMILY_ID>/revoke
```

–≠—Ñ—Ñ–µ–∫—Ç:

1. –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ refresh-—Ç–æ–∫–µ–Ω—ã —Å–µ–º—å–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è revoked.
2. –í `session_refresh_audit` –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å `reason=manual_revoke` + `revocation_reason=<reason>`.
3. –í `events` —Å–æ–∑–¥–∞—ë—Ç—Å—è `session_family_revoked`.
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏–¥—ë—Ç—Å—è –∑–∞–Ω–æ–≤–æ –ø—Ä–æ–π—Ç–∏ `/auth/tma`.

## –¢–∏–ø–æ–≤—ã–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã –∏ –¥–µ–π—Å—Ç–≤–∏—è

| –°–∏—Ç—É–∞—Ü–∏—è | –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ | –†–µ—à–µ–Ω–∏–µ |
| --- | --- | --- |
| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∂–∞–ª—É—é—Ç—Å—è –Ω–∞ ¬´—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è¬ª | –°–º–æ—Ç—Ä–µ—Ç—å `auth_rate_limit_triggered` + Grafana (rate_limited) | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `AUTH_RATE_LIMIT_MAX`, IP-–∞–≥—Ä–µ–≥–∞—Ç–æ—Ä—ã; –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–¥–Ω—è—Ç—å –ª–∏–º–∏—Ç –∏ —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |
| –í –ª–æ–≥–∞—Ö `auth_data_expired_renew` | –û–±—ã—á–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ—Ä–∂–∞–ª Mini App > 24‚ÄØ—á | –ü–æ–¥—Å–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Mini App (Telegram –≤—ã–¥–∞—Å—Ç —Å–≤–µ–∂—É—é –ø–æ–¥–ø–∏—Å—å) |
| –ú–Ω–æ–≥–æ `session_family_revoked` —Å trigger `refresh_not_found` | –í–µ—Ä–æ—è—Ç–Ω–æ, —Å—Ç–∞—Ä—ã–µ refresh-—Ç–æ–∫–µ–Ω—ã –æ—Ç –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ | –ü—Ä–æ–∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ –Ω—É–∂–Ω–æ –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ. –°–ª–µ–¥–∏—Ç—å –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–æ–±—ã—Ç–∏–π |
| Grafana –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–æ—Å—Ç `user_mismatch` | –í–æ–∑–º–æ–∂–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ | –°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–∏ ‚Äî —Ä–µ–≤–æ–∫–∞—Ü–∏—è —Å–µ–º—å–∏ –≤—Ä—É—á–Ω—É—é |

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ñ—Ä–æ–Ω—Ç–µ

- –•—Ä–∞–Ω–µ–Ω–∏–µ `refreshExpiresAt` –≤ `localStorage` (`refresh_expires_at_ms`) ‚Äî –µ—Å–ª–∏ –≤—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ, Session Manager —Å–∞–º –¥–µ–ª–∞–µ—Ç `forceReauth`.
- –ü—Ä–∏ 429 —Ñ—Ä–æ–Ω—Ç —É–≤–∞–∂–∞–µ—Ç `Retry-After`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –±—ç–∫-–æ—Ñ—Ñ –∏ –ª–æ–≥–∏—Ä—É–µ—Ç `auth_refresh_rate_limited`.
- –ü—Ä–∏ `auth_data_expired_renew` –≤—ã–≤–æ–¥–∏—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏—Å—Ç—ë–∫. –ó–∞–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –∑–∞–Ω–æ–≤–æ¬ª.

## –ë—ã—Å—Ç—Ä—ã–π —á–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º

1. `npm run migrate:up` –ø—Ä–∏–º–µ–Ω–∏–ª `013_session_family_revocation`.
2. `railway variables --service backgame --kv` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –≤—ã—à–µ.
3. smoke-—Ç–µ—Å—Ç `/auth/tma` + `/auth/refresh` (Postman/CURL, –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å initData –∏ refresh).
4. `curl /metrics` —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—á—ë—Ç—á–∏–∫–∏ `energyplanet_auth_*`.
5. –í Grafana üëÄ –¥–∞—à–±–æ—Ä–¥ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, –∞–ª–µ—Ä—Ç—ã –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω—ã (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è).

–ì–æ—Ç–æ–≤–æ ‚Äî —Ç–µ–ø–µ—Ä—å –ª—é–±—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ø–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞ –º–∏–Ω—É—Ç—ã.
