# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–µ–π—á–∞—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤—Ä—É—á–Ω—É—é –≤–≤–æ–¥–∏—Ç—å –∫–æ–¥ ‚Üí 90% –±—Ä–æ—Å–∞—é—Ç!

**–†–µ—à–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram deep linking

---

## üî¥ –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ü–õ–û–•–û)

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –°–ï–ô–ß–ê–°:

**1. –ú–∞–∫—Å –¥–µ–ª–∏—Ç—Å—è —Å—Å—ã–ª–∫–æ–π:**
```
Backend –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç:
https://t.me/share/url?url=https://t.me/energyplanetbot/app?startapp=ref_EP-XK7M
```

**2. –î–∏–º–∞ –∫–ª–∏–∫–∞–µ—Ç –Ω–∞ —Å—Å—ã–ª–∫—É:**
```
Telegram –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Mini App
URL: https://t.me/energyplanetbot/app?startapp=ref_EP-XK7M
                                       ‚Üë
                                    –ü–∞—Ä–∞–º–µ—Ç—Ä –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è
```

**3. –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
```
‚ùå Frontend –ù–ï —á–∏—Ç–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä startapp
‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∞ –æ–±—ã—á–Ω—ã–π —ç–∫—Ä–∞–Ω
‚ùå –î–∏–º–∞ –¥–æ–ª–∂–µ–Ω –≤—Ä—É—á–Ω—É—é:
   1. –ù–∞–π—Ç–∏ Settings
   2. –ù–∞–π—Ç–∏ –ø–æ–ª–µ "–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥—Ä—É–≥–∞"
   3. –í–≤–µ—Å—Ç–∏ EP-XK7M
   4. –ù–∞–∂–∞—Ç—å "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 90% –±—Ä–æ—Å–∞—é—Ç –Ω–∞ –ø–æ–ª–ø—É—Ç–∏! üò¢

---

## ‚úÖ –ö–∞–∫ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å (–ü–†–ê–í–ò–õ–¨–ù–û)

### –ò–¥–µ–∞–ª—å–Ω—ã–π Flow:

**1. –ú–∞–∫—Å –¥–µ–ª–∏—Ç—Å—è —Å—Å—ã–ª–∫–æ–π** (—Ç–æ –∂–µ —Å–∞–º–æ–µ)

**2. –î–∏–º–∞ –∫–ª–∏–∫–∞–µ—Ç –Ω–∞ —Å—Å—ã–ª–∫—É**

**3. Mini App –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:**
```typescript
Telegram WebApp API –ø–µ—Ä–µ–¥–∞–µ—Ç:
window.Telegram.WebApp.initDataUnsafe.start_param = "ref_EP-XK7M"
                                                     ‚Üë
                                            –ö–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
```

**4. Frontend –ª–æ–≤–∏—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä:**
```typescript
‚úÖ –ß–∏—Ç–∞–µ–º start_param –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ app
‚úÖ –ü–∞—Ä—Å–∏–º –∫–æ–¥: "ref_EP-XK7M" ‚Üí "EP-XK7M"
‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º: –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å? –ï—â–µ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª –∫–æ–¥?
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ–º API: activateReferralCode("EP-XK7M")
```

**5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç:**
```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   üéâ –î–û–ë–†–û –ü–û–ñ–ê–õ–û–í–ê–¢–¨!               ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                      ‚ïë
‚ïë  –ú–∞–∫—Å –ø—Ä–∏–≥–ª–∞—Å–∏–ª —Ç–µ–±—è!                ‚ïë
‚ïë                                      ‚ïë
‚ïë  –¢—ã –ø–æ–ª—É—á–∏–ª:                         ‚ïë
‚ïë  ‚≠ê +300 –∑–≤–µ–∑–¥                        ‚ïë
‚ïë  üñºÔ∏è –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞—è —Ä–∞–º–∫–∞                ‚ïë
‚ïë                                      ‚ïë
‚ïë  [–ù–∞—á–∞—Ç—å –∏–≥—Ä–∞—Ç—å] üëà –û–î–ò–ù –ö–õ–ò–ö!       ‚ïë
‚ïë                                      ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
```

**Conversion rate:** 90% –≤–º–µ—Å—Ç–æ 10%! üöÄ

---

## üì± –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Telegram Mini Apps

### Telegram WebApp API

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç –Ω–∞ —Å—Å—ã–ª–∫—É —Ç–∏–ø–∞:
```
https://t.me/botname/app?startapp=–ü–ê–†–ê–ú–ï–¢–†
```

Telegram –ø–µ—Ä–µ–¥–∞–µ—Ç `–ü–ê–†–ê–ú–ï–¢–†` –≤ Mini App —á–µ—Ä–µ–∑:

```javascript
window.Telegram.WebApp.initDataUnsafe.start_param
```

**–í–∞–∂–Ω–æ:**
- `startapp=ref_EP-XK7M` ‚Üí `start_param = "ref_EP-XK7M"`
- –ü–∞—Ä–∞–º–µ—Ç—Ä –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–∏ **–ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ** (—á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫—É)
- –ü—Ä–∏ –æ–±—ã—á–Ω–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ (–∏–∑ –º–µ–Ω—é) ‚Äî `start_param` –±—É–¥–µ—Ç `undefined`

---

## üíª –ò–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è

### –®–∞–≥ 1: –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `webapp/src/utils/telegram.ts`

```typescript
/**
 * –ü–æ–ª—É—á–∏—Ç—å start_param –∏–∑ Telegram WebApp
 * –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫—É —Å startapp –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
 */
export function getTelegramStartParam(): string | null {
  if (typeof window === 'undefined') {
    return null
  }

  try {
    const webApp = (window as any).Telegram?.WebApp
    if (!webApp) {
      console.warn('Telegram WebApp not available')
      return null
    }

    // Telegram –ø–µ—Ä–µ–¥–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä —á–µ—Ä–µ–∑ initDataUnsafe.start_param
    const startParam = webApp.initDataUnsafe?.start_param

    if (!startParam || typeof startParam !== 'string') {
      return null
    }

    return startParam
  } catch (error) {
    console.error('Error reading Telegram start param:', error)
    return null
  }
}

/**
 * –ü–∞—Ä—Å–∏—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ start_param
 *
 * –§–æ—Ä–º–∞—Ç: "ref_EP-XK7M" ‚Üí "EP-XK7M"
 */
export function parseReferralCode(startParam: string | null): string | null {
  if (!startParam) {
    return null
  }

  // –§–æ—Ä–º–∞—Ç: ref_CODE
  const match = startParam.match(/^ref_(.+)$/)
  if (!match) {
    return null
  }

  const code = match[1]

  // Validate code format (EP-XXXX)
  if (!/^EP-[A-Z0-9]{4}$/.test(code)) {
    console.warn('Invalid referral code format:', code)
    return null
  }

  return code
}
```

---

### –®–∞–≥ 2: Hook –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `webapp/src/hooks/useAutoReferral.ts`

```typescript
import { useEffect, useRef } from 'react'
import { useReferralStore } from '@/store/referralStore'
import { getTelegramStartParam, parseReferralCode } from '@/utils/telegram'
import { useNotification } from '@/hooks/useNotification'

/**
 * Hook –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
 * –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫—É
 *
 * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
 * - –î–æ–±–∞–≤–∏—Ç—å –≤ App.tsx –∏–ª–∏ main layout
 * - –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ mount
 * - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç start_param –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∫–æ–¥ –µ—Å–ª–∏ –µ—Å—Ç—å
 */
export function useAutoReferral() {
  const { success, error: notifyError } = useNotification()
  const { referral, activateCode } = useReferralStore()
  const attempted = useRef(false)

  useEffect(() => {
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
    if (attempted.current) {
      return
    }

    attempted.current = true

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
    async function tryAutoActivate() {
      // –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º start_param –∏–∑ Telegram
      const startParam = getTelegramStartParam()
      if (!startParam) {
        console.log('No start param found')
        return
      }

      console.log('Start param detected:', startParam)

      // –®–∞–≥ 2: –ü–∞—Ä—Å–∏–º –∫–æ–¥
      const code = parseReferralCode(startParam)
      if (!code) {
        console.warn('Could not parse referral code from start param')
        return
      }

      console.log('Referral code parsed:', code)

      // –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª –∫–æ–¥ ‚Üí skip
      if (referral?.referredBy) {
        console.log('User already referred by someone, skipping')
        return
      }

      // –®–∞–≥ 4: –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
      try {
        console.log('Auto-activating referral code:', code)

        await activateCode(code)

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        success(
          `üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –¢—ã –ø–æ–ª—É—á–∏–ª 300‚≠ê –æ—Ç –¥—Ä—É–≥–∞!`,
          { duration: 5000 }
        )

        // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø–æ–∫–∞–∑–∞—Ç—å welcome modal
        // showWelcomeModal(referral)

      } catch (err: unknown) {
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
        const errorMessage = err instanceof Error ? err.message : 'Unknown error'

        // –†–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫:
        if (errorMessage.includes('already_referred')) {
          console.log('User already referred, this is fine')
          // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
          return
        }

        if (errorMessage.includes('self_referral')) {
          console.warn('Self-referral attempt detected')
          // –¢–æ–∂–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
          return
        }

        if (errorMessage.includes('not_found')) {
          console.error('Invalid referral code:', code)
          notifyError('–ù–µ–≤–µ—Ä–Ω—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥')
          return
        }

        // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞
        console.error('Auto-activation failed:', err)
        notifyError('–ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏')
      }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
    // –ß—Ç–æ–±—ã Telegram WebApp —É—Å–ø–µ–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è
    setTimeout(() => {
      void tryAutoActivate()
    }, 500)

  }, [referral, activateCode, success, notifyError])
}
```

---

### –®–∞–≥ 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ App

**–û–±–Ω–æ–≤–∏—Ç—å:** `webapp/src/App.tsx` (–∏–ª–∏ –≥–ª–∞–≤–Ω—ã–π layout)

```typescript
import { useAutoReferral } from '@/hooks/useAutoReferral'

export function App() {
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
  useAutoReferral()

  return (
    <div>
      {/* –í–∞—à app */}
    </div>
  )
}
```

**–í–æ—Ç –∏ –≤—Å—ë!** üéâ

---

### –®–∞–≥ 4: –£–ª—É—á—à–µ–Ω–Ω—ã–π Welcome Modal (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–°–æ–∑–¥–∞—Ç—å:** `webapp/src/components/referral/WelcomeModal.tsx`

```typescript
import { Modal } from '@/components/Modal'
import { Button } from '@/components/Button'
import { formatNumberWithSpaces } from '@/utils/number'

interface WelcomeModalProps {
  isOpen: boolean
  onClose: () => void
  referrerName?: string
  reward: {
    stars: number
    cosmeticId?: string
  }
}

export function WelcomeModal({ isOpen, onClose, referrerName, reward }: WelcomeModalProps) {
  return (
    <Modal isOpen={isOpen} onClose={onClose}>
      <div className="flex flex-col items-center gap-md text-center p-lg">
        {/* –ê–Ω–∏–º–∞—Ü–∏—è –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ */}
        <div className="text-6xl">üéâ</div>

        <h2 className="text-2xl font-bold">
          –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!
        </h2>

        {referrerName && (
          <p className="text-body">
            <strong>{referrerName}</strong> –ø—Ä–∏–≥–ª–∞—Å–∏–ª —Ç–µ–±—è
          </p>
        )}

        <div className="flex flex-col gap-sm w-full">
          <div className="rounded-2xl bg-gradient-to-br from-amber-500/20 to-orange-500/20 border border-amber-500/40 p-md">
            <div className="text-caption uppercase text-amber-600 mb-2">
              –¢—ã –ø–æ–ª—É—á–∏–ª
            </div>
            <div className="text-3xl font-bold text-amber-500">
              +{formatNumberWithSpaces(reward.stars)}‚≠ê
            </div>
            {reward.cosmeticId && (
              <div className="text-caption text-text-secondary mt-2">
                + –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞—è –∫–æ—Å–º–µ—Ç–∏–∫–∞
              </div>
            )}
          </div>

          <p className="text-caption text-text-secondary">
            –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å –∫—É–ø–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏—è, –æ—Ç–∫—Ä—ã—Ç—å –∫–æ—Å–º–æ-—è—â–∏–∫–∏
            –∏–ª–∏ —É—Å–∫–æ—Ä–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å!
          </p>
        </div>

        <Button
          variant="primary"
          size="lg"
          onClick={onClose}
          className="w-full"
        >
          –ù–∞—á–∞—Ç—å –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ üöÄ
        </Button>
      </div>
    </Modal>
  )
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ hook:**

```typescript
// –í useAutoReferral.ts

import { useState } from 'react'
import { WelcomeModal } from '@/components/referral/WelcomeModal'

export function useAutoReferral() {
  const [showWelcome, setShowWelcome] = useState(false)
  const [welcomeData, setWelcomeData] = useState(null)

  // ... existing code

  // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:
  const result = await activateCode(code)

  setWelcomeData({
    referrerName: result.referredBy?.username || result.referredBy?.firstName,
    reward: {
      stars: result.inviteeReward.stars,
      cosmeticId: result.inviteeReward.cosmeticId
    }
  })
  setShowWelcome(true)

  // Render modal:
  return (
    <>
      {showWelcome && welcomeData && (
        <WelcomeModal
          isOpen={showWelcome}
          onClose={() => setShowWelcome(false)}
          {...welcomeData}
        />
      )}
    </>
  )
}
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**1. Mock Telegram WebApp:**

```typescript
// –í dev environment
if (process.env.NODE_ENV === 'development') {
  // –°–∏–º—É–ª–∏—Ä—É–µ–º Telegram WebApp
  (window as any).Telegram = {
    WebApp: {
      initDataUnsafe: {
        start_param: 'ref_EP-TEST'  // –¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥
      }
    }
  }
}
```

**2. –¢–µ—Å—Ç —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:**

```typescript
// Scenario 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –∫–æ–¥–æ–º
start_param = "ref_EP-XK7M"
‚Üí –î–æ–ª–∂–µ–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
‚Üí –ü–æ–∫–∞–∑–∞—Ç—å welcome modal

// Scenario 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª –∫–æ–¥
start_param = "ref_EP-XK7M"
referral.referredBy = { userId: '...' }
‚Üí –î–æ–ª–∂–µ–Ω skip
‚Üí –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∏—á–µ–≥–æ

// Scenario 3: –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –∫–æ–¥
start_param = "ref_INVALID"
‚Üí –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
‚Üí –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å

// Scenario 4: –ù–µ—Ç start_param
start_param = undefined
‚Üí –î–æ–ª–∂–µ–Ω skip
‚Üí –û–±—ã—á–Ω—ã–π –∑–∞–ø—É—Å–∫
```

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ (Analytics)

–î–æ–±–∞–≤—å—Ç–µ tracking –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:

```typescript
// –í useAutoReferral.ts

import { logClientEvent } from '@/services/telemetry'

// –ö–æ–≥–¥–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–∞–π–¥–µ–Ω
logClientEvent('referral_start_param_detected', { code })

// –ö–æ–≥–¥–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
logClientEvent('referral_auto_activated', {
  code,
  source: 'telegram_link'
})

// –ö–æ–≥–¥–∞ –æ—à–∏–±–∫–∞
logClientEvent('referral_auto_activation_failed', {
  code,
  error: errorMessage
})

// –ö–æ–≥–¥–∞ skip (—É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω)
logClientEvent('referral_auto_activation_skipped', {
  reason: 'already_referred'
})
```

**–í–∞–∂–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
```
Funnel:
1. start_param_detected   (100%)
2. auto_activated         (95%)  ‚Üê –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤—ã—Å–æ–∫–æ!
3. activation_failed      (3%)
4. activation_skipped     (2%)

Target:
- Activation rate: >90%
- Error rate: <5%
```

---

## üîÑ Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é Telegram –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ startapp:

```typescript
export function getTelegramStartParam(): string | null {
  // Modern API (Telegram >= 6.9)
  const modernParam = webApp.initDataUnsafe?.start_param
  if (modernParam) {
    return modernParam
  }

  // Fallback: parse from URL
  // –î–ª—è –æ—á–µ–Ω—å —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ URL
  const urlParams = new URLSearchParams(window.location.search)
  const legacyParam = urlParams.get('tgWebAppStartParam')
  if (legacyParam) {
    return legacyParam
  }

  return null
}
```

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏

### –ö–æ–Ω–≤–µ—Ä—Å–∏—è:

**–ë–µ–∑ –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏:**
```
100 –∫–ª–∏–∫–æ–≤ –Ω–∞ —Å—Å—ã–ª–∫—É
‚Üí 50 –æ—Ç–∫—Ä—ã–ª–∏ app (50%)
‚Üí 10 –Ω–∞—à–ª–∏ Settings (20%)
‚Üí 5 –≤–≤–µ–ª–∏ –∫–æ–¥ –ø—Ä–∞–≤–∏–ª—å–Ω–æ (10%)
‚Üí 5 –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ (10%)

Conversion: 5%
```

**–° –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π:**
```
100 –∫–ª–∏–∫–æ–≤ –Ω–∞ —Å—Å—ã–ª–∫—É
‚Üí 95 –æ—Ç–∫—Ä—ã–ª–∏ app (95%)
‚Üí 90 –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞ (95%)

Conversion: 90%
```

**–†–æ—Å—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏–∏: 18√ó (1800%)!** üöÄ

---

### UX –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

**–ë—ã–ª–æ:**
1. –ö–ª–∏–∫ –Ω–∞ —Å—Å—ã–ª–∫—É
2. –û—Ç–∫—Ä—ã—Ç—å app
3. –ù–∞–π—Ç–∏ Settings
4. –ù–∞–π—Ç–∏ –ø–æ–ª–µ "–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥"
5. –í—Å–ø–æ–º–Ω–∏—Ç—å –∫–æ–¥ (–∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ Telegram)
6. –í–≤–µ—Å—Ç–∏ –∫–æ–¥
7. –ù–∞–∂–∞—Ç—å "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"

**7 —à–∞–≥–æ–≤!** üò∞

**–°—Ç–∞–ª–æ:**
1. –ö–ª–∏–∫ –Ω–∞ —Å—Å—ã–ª–∫—É
2. –û—Ç–∫—Ä—ã—Ç—å app
3. –£–≤–∏–¥–µ—Ç—å "–¢—ã –ø–æ–ª—É—á–∏–ª 300‚≠ê!"
4. –ù–∞–∂–∞—Ç—å "–ù–∞—á–∞—Ç—å –∏–≥—Ä–∞—Ç—å"

**4 —à–∞–≥–∞!** üòä

---

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: start_param –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω—ã:**
1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏
2. Telegram WebApp –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
3. –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è Telegram

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –î–æ–±–∞–≤–∏—Ç—å debug logging
console.log('Telegram WebApp:', window.Telegram?.WebApp)
console.log('Init data:', window.Telegram?.WebApp?.initDataUnsafe)
console.log('Start param:', window.Telegram?.WebApp?.initDataUnsafe?.start_param)
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏

**–ü—Ä–∏—á–∏–Ω–∞:** Hook —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `useRef` –¥–ª—è —Ñ–ª–∞–≥–∞:
```typescript
const attempted = useRef(false)

useEffect(() => {
  if (attempted.current) return
  attempted.current = true
  // ...
}, [])
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: Self-referral –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —à–∞—Ä–∏—Ç —Å–≤–æ—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É

**–†–µ—à–µ–Ω–∏–µ:** Backend —É–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —ç—Ç–æ:
```typescript
// backend/src/services/ReferralService.ts:146
if (codeRecord.userId === userId) {
  throw new AppError(409, 'referral_self_not_allowed')
}
```

Frontend –¥–æ–ª–∂–µ–Ω –ø—Ä–æ—Å—Ç–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫—É:
```typescript
if (errorMessage.includes('self_referral')) {
  // Silent fail, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
  return
}
```

---

## ‚úÖ Checklist –¥–ª—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

- [ ] –°–æ–∑–¥–∞—Ç—å `webapp/src/utils/telegram.ts`
- [ ] –°–æ–∑–¥–∞—Ç—å `webapp/src/hooks/useAutoReferral.ts`
- [ ] –î–æ–±–∞–≤–∏—Ç—å `useAutoReferral()` –≤ App.tsx
- [ ] –°–æ–∑–¥–∞—Ç—å WelcomeModal –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –î–æ–±–∞–≤–∏—Ç—å analytics tracking
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å mock –¥–∞–Ω–Ω—ã–º–∏
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ Telegram (dev bot)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å edge cases (self-referral, already referred)
- [ ] Deploy –≤ production
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

–ü–æ—Å–ª–µ –±–∞–∑–æ–≤–æ–π –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏:

1. **Deep linking –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —é–∑–µ—Ä–æ–≤:**
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –∏–≥—Ä–µ
   - –ü–æ–∫–∞–∑–∞—Ç—å "–¢–≤–æ–π –¥—Ä—É–≥ –ú–∞–∫—Å –∏–≥—Ä–∞–µ—Ç! –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è?"

2. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è welcome screen:**
   - –ü–æ–∫–∞–∑–∞—Ç—å –∞–≤–∞—Ç–∞—Ä –¥—Ä—É–≥–∞
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥—Ä—É–≥–∞ (—É—Ä–æ–≤–µ–Ω—å, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è)

3. **Pre-game tutorial —Å –¥—Ä—É–≥–æ–º:**
   - "–ú–∞–∫—Å —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –ø—Ä–æ–π—Ç–∏ —Ç—É—Ç–æ—Ä–∏–∞–ª"
   - –ë–æ–Ω—É—Å—ã –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ

4. **Social proof:**
   - "10 –≤–∞—à–∏—Ö –æ–±—â–∏—Ö –¥—Ä—É–∑–µ–π —É–∂–µ –∏–≥—Ä–∞—é—Ç!"

---

**–≠—Ç–æ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –≤–∞–∂–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ!**

–ë–µ–∑ –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏: 5-10% –∫–æ–Ω–≤–µ—Ä—Å–∏—è
–° –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π: 85-95% –∫–æ–Ω–≤–µ—Ä—Å–∏—è

**ROI: –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –∑–∞–Ω–∏–º–∞–µ—Ç 2-3 —á–∞—Å–∞, —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏—é –≤ 18√ó**
