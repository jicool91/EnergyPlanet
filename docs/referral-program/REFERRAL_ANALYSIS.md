# Ğ“Ğ»ÑƒĞ±Ğ¾ĞºĞ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹ Energy Planet

**Ğ”Ğ°Ñ‚Ğ°:** 2025-11-16
**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** Completed
**ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸Ğº:** Claude Code

---

## Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ

1. [Executive Summary](#executive-summary)
2. [Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°](#Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ-Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°)
3. [Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ](#Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ)
4. [Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ Ğ¸Ğ½Ğ´ÑƒÑÑ‚Ñ€Ğ¸ĞµĞ¹](#ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ-Ñ-Ğ¸Ğ½Ğ´ÑƒÑÑ‚Ñ€Ğ¸ĞµĞ¹)
5. [ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹](#ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ-Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹)
6. [ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¸ KPI](#Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸-Ğ¸-kpi)
7. [Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸](#Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸)

---

## Executive Summary

### ĞĞ±Ñ‰Ğ°Ñ Ğ¾Ñ†ĞµĞ½ĞºĞ°: 6.5/10

**Ğ¡Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹:**
- âœ… Solid Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° (Repository â†’ Service â†’ Controller)
- âœ… Ğ”Ğ²ÑƒÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ½Ğ¸Ğµ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñ‹ (industry standard)
- âœ… ĞœĞ½Ğ¾Ğ³Ğ¾ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ²Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¼Ğ¸Ğ»ĞµÑÑ‚Ğ¾ÑƒĞ½Ğ¾Ğ²
- âœ… Revenue share Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼ (1% Ğ¾Ñ‚ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº)
- âœ… ĞŸÑ€Ğ¾Ğ¼Ğ¾-ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ñ Ğ¼Ğ½Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑĞ¼Ğ¸
- âœ… Telegram native Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ

**ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ñ‹:**
- âŒ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ fraud prevention (ÑƒÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ°Ğ±ÑŒÑĞ·Ğ°)
- âŒ ĞĞµÑ‚ leaderboard Ğ¸ ÑĞ¾Ñ€ĞµĞ²Ğ½Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
- âŒ Ğ¡Ğ»Ğ°Ğ±Ğ°Ñ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ gameplay
- âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ°Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°
- âŒ ĞĞµĞ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ñ€Ğ°Ğ·Ğ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Settings/Friends)

**ĞŸĞ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ» Ñ€Ğ¾ÑÑ‚Ğ°:**
- Viral Coefficient: 0.3-0.5 â†’ 0.8-1.2 (+160%)
- Fraud Rate: 30-40% â†’ 5-8% (-75%)
- Conversion Rate: 5-10% â†’ 15-25% (+150%)
- D7 Retention: 20-30% â†’ 40-55% (+80%)

---

## Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

### Backend ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°

```
backend/
â”œâ”€â”€ migrations/
â”‚   â”œâ”€â”€ 011_referrals.sql              # Core tables
â”‚   â””â”€â”€ 014_referral_revenue.sql       # Revenue share
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ ReferralService.ts         # Main business logic
â”‚   â”‚   â””â”€â”€ ReferralRevenueService.ts  # Revenue calculations
â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”œâ”€â”€ ReferralRepository.ts      # CRUD operations
â”‚   â”‚   â””â”€â”€ ReferralRevenueRepository.ts
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ controllers/ReferralController.ts
â”‚   â”‚   â””â”€â”€ routes/referrals.ts
â”‚   â””â”€â”€ services/__tests__/
â”‚       â””â”€â”€ ReferralRevenueService.spec.ts
â””â”€â”€ content/
    â””â”€â”€ referrals.json                 # Configuration
```

### Frontend ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°

```
webapp/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ store/
â”‚   â”‚   â”œâ”€â”€ referralStore.ts           # Zustand state
â”‚   â”‚   â””â”€â”€ referralRevenueStore.ts
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ referrals.ts               # API client
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ settings/ReferralInviteCard.tsx
â”‚       â””â”€â”€ friends/ReferralRevenueCard.tsx
```

### Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

#### referral_codes
```sql
Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°: Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… ĞºĞ¾Ğ´Ğ¾Ğ²
ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ:
- id (UUID)
- user_id (UUID, UNIQUE) - Ğ¾Ğ´Ğ¸Ğ½ ĞºĞ¾Ğ´ Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
- code (VARCHAR 16, UNIQUE) - Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: EP-XXXX
- created_at

Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹:
- PRIMARY KEY (id)
- UNIQUE (user_id)
- UNIQUE (code)
```

#### referral_relations
```sql
Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°: Ğ¡Ğ²ÑĞ·Ğ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ğ²ÑˆĞ¸Ğ¼ Ğ¸ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ½Ñ‹Ğ¼
ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ:
- id (UUID)
- referrer_id (UUID) - ĞºÑ‚Ğ¾ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ğ»
- referred_id (UUID, UNIQUE) - ĞºÑ‚Ğ¾ Ğ±Ñ‹Ğ» Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½
- status (VARCHAR 20) - 'activated'
- activated_at
- first_purchase_at (NULLABLE) âš ï¸ ĞĞ• Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ•Ğ¢Ğ¡Ğ¯
- metadata (JSONB) - Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ ĞºĞ¾Ğ´

Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹:
- PRIMARY KEY (id)
- UNIQUE (referred_id) - Ğ¾Ğ´Ğ¸Ğ½ Ñ€ĞµÑ„ĞµÑ€ĞµÑ€ Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
- INDEX (referrer_id)
```

#### referral_rewards
```sql
Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°: Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ²Ñ‹Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¼Ğ¸Ğ»ĞµÑÑ‚Ğ¾ÑƒĞ½ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´
ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ:
- id (UUID)
- referrer_id (UUID)
- milestone_id (VARCHAR 64)
- reward_payload (JSONB)
- granted_at

ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ:
- UNIQUE(referrer_id, milestone_id) - Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· Ğ½Ğ° Ğ¼Ğ¸Ğ»ĞµÑÑ‚Ğ¾ÑƒĞ½
```

#### referral_revenue_events
```sql
Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°: Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ğ¹ revenue share
ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ:
- id (UUID)
- referrer_id (UUID)
- referred_id (UUID)
- referral_relation_id (UUID)
- purchase_id (VARCHAR 128)
- purchase_amount (BIGINT)
- share_amount (BIGINT)
- source (VARCHAR 50)
- metadata (JSONB)
- referred_username, referred_first_name
- granted_at

Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:
- ĞÑƒĞ´Ğ¸Ñ‚ Ğ²ÑĞµÑ… Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ğ¹
- ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ·Ğ°Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°
```

#### referral_revenue_totals
```sql
Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°: ĞĞ³Ñ€ĞµĞ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° revenue share
ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ:
- referral_relation_id (PRIMARY KEY)
- referrer_id, referred_id
- total_share_amount (BIGINT)
- total_purchase_amount (BIGINT)
- last_purchase_id, last_share_amount, last_purchase_amount
- last_purchase_at
- updated_at

ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ:
- Ğ”ĞµĞ½Ğ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
- ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞµ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ°
```

---

## Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ

### 1. Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ´Ğ°

**Ğ¤Ğ°Ğ¹Ğ»:** `backend/src/services/ReferralService.ts:123`

```typescript
// Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: EP-XXXX
// ĞĞ»Ñ„Ğ°Ğ²Ğ¸Ñ‚: ABCDEFGHJKLMNPQRSTUVWXYZ23456789 (Ğ±ĞµĞ· 0,O,1,I,L)
// Ğ”Ğ»Ğ¸Ğ½Ğ°: 8 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²
// Collision handling: 5 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº
```

**Ğ¥Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ¸ÑÑ‚Ğ¸ĞºĞ¸:**
- Human-readable (Ğ±ĞµĞ· Ğ¿Ğ¾Ñ…Ğ¾Ğ¶Ğ¸Ñ… ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)
- Case-insensitive Ğ¿Ñ€Ğ¸ Ğ²Ğ²Ğ¾Ğ´Ğµ
- ĞĞ²Ñ‚Ğ¾Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ summary
- ĞĞ´Ğ¸Ğ½ ĞºĞ¾Ğ´ Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (lifetime)

### 2. ĞĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ´Ğ°

**Ğ¤Ğ°Ğ¹Ğ»:** `backend/src/services/ReferralService.ts:89`

**Flow:**
```
1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ²Ğ¾Ğ´Ğ¸Ñ‚ ĞºĞ¾Ğ´ Ğ´Ñ€ÑƒĞ³Ğ°
2. Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ:
   âœ… ĞšĞ¾Ğ´ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚
   âœ… ĞĞµ self-referral
   âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ĞµÑ‰Ğµ Ğ½Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ» ĞºĞ¾Ğ´
   âœ… Daily limit Ñ€ĞµÑ„ĞµÑ€ĞµÑ€Ğ° (10/Ğ´ĞµĞ½ÑŒ)
3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ relation (bidirectional)
4. ĞœĞ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñ‹:
   - Invitee: 300â­ + frame
   - Referrer: 350â­
5. Apply event multipliers
6. Log events + invalidate caches
```

**Ğ›Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹:**
- ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 10 Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¹ Ğ² Ğ´ĞµĞ½ÑŒ Ğ½Ğ° Ñ€ĞµÑ„ĞµÑ€ĞµÑ€Ğ°
- ĞĞ´Ğ¸Ğ½ ĞºĞ¾Ğ´ Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°)
- ĞĞµÑ‚ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ âš ï¸

### 3. Milestone ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°

**Ğ¤Ğ°Ğ¹Ğ»:** `backend/content/referrals.json:14-48`

| Milestone | Threshold | Stars | Cosmetic | Type |
|-----------|-----------|-------|----------|------|
| ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ ÑĞºĞ¸Ğ¿Ğ°Ğ¶ | 1 | 500 | frame_starlight | Frame |
| Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞºÑĞ¿ĞµĞ´Ğ¸Ñ†Ğ¸Ğ¸ | 5 | 1500 | - | Bonus |
| Ğ“Ğ°Ğ»Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ĞºĞ»ÑƒĞ± | 15 | 3500 | aura_galactic_trail | Aura |
| ĞšÑ€ÑƒĞ³ Ğ»ĞµĞ³ĞµĞ½Ğ´ | 30 | 8000 | badge_referral_champion | Badge |

**ĞœĞµÑ…Ğ°Ğ½Ğ¸ĞºĞ°:**
- Claim Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼
- ĞĞ´Ğ½Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ (Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ)
- Daily limit: 5 claims Ğ² Ğ´ĞµĞ½ÑŒ
- Event multipliers Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑÑÑ‚ÑÑ

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹:**
- âš ï¸ Ğ‘Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ gap Ğ¼ĞµĞ¶Ğ´Ñƒ 1 Ğ¸ 5 Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ°Ğ¼Ğ¸
- âš ï¸ ĞĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼ĞµĞ¶ÑƒÑ‚Ğ¾Ñ‡Ğ½Ñ‹Ñ… milestone

### 4. Revenue Share

**Ğ¤Ğ°Ğ¹Ğ»:** `backend/src/services/ReferralRevenueService.ts:69`

**ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ:**
```json
{
  "sharePercentage": 0.01,      // 1%
  "dailyRewardCap": 2000,       // 2000â­/Ğ´ĞµĞ½ÑŒ
  "monthlyRewardCap": 10000,    // 10000â­/Ğ¼ĞµÑÑÑ†
  "lifetimeRewardCap": null     // ĞĞµÑ‚ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ°
}
```

**Flow:**
```
1. Ğ ĞµÑ„ĞµÑ€Ğ°Ğ» ÑĞ¾Ğ²ĞµÑ€ÑˆĞ°ĞµÑ‚ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºÑƒ (stars/items)
2. PurchaseService.ts Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ handlePurchaseReward()
3. Ğ Ğ°ÑÑ‡ĞµÑ‚:
   raw_share = purchase_amount Ã— 0.01
4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ°Ğ¿Ğ¾Ğ²:
   daily_remaining = 2000 - sum_today()
   monthly_remaining = 10000 - sum_month()
5. Final amount = min(raw_share, daily_remaining, monthly_remaining)
6. Grant stars + insert event + update totals
7. Invalidate cache
```

**Issues:**
- âš ï¸ Race condition Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¾Ğ¹ ĞºĞ°Ğ¿Ğ° Ğ¸ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸ĞµĞ¼
- âš ï¸ ĞĞµÑ‚ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ñ row-lock

### 5. Promotional Events

**Ğ¤Ğ°Ğ¹Ğ»:** `backend/content/referrals.json:50-78`

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ:**
```json
{
  "id": "double_weekend",
  "name": "Double Weekend",
  "start": "2024-11-01T00:00:00Z",
  "end": "2024-11-03T23:59:59Z",
  "multipliers": {
    "inviteeReward": 2.0,
    "referrerReward": 2.0,
    "milestoneReward": 1.5
  }
}
```

**Ğ­Ñ„Ñ„ĞµĞºÑ‚Ñ‹:**
- Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğµ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´
- Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ FOMO
- ĞœĞ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ (ÑÑ‚Ğ°ĞºĞ°ÑÑ‚ÑÑ)

### 6. Sharing Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼

**Ğ¤Ğ°Ğ¹Ğ»:** `webapp/src/components/settings/ReferralInviteCard.tsx:67`

**ĞœĞµÑ‚Ğ¾Ğ´Ñ‹:**
```typescript
1. Telegram Native Share
   - WebApp.openTelegramLink()
   - ĞŸÑ€ĞµĞ´Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
   - StartApp Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€

2. Copy Code
   - Clipboard API
   - Fallback Ğ´Ğ»Ñ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ¾Ğ²
   - Toast notification

3. Share Link
   - Native Share API (mobile)
   - Ğ¤Ğ¾Ğ»Ğ»Ğ±ĞµĞº Ğ½Ğ° copy
```

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹:**
- âŒ ĞĞµÑ‚ tracking ĞºĞ°ĞºĞ¾Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½
- âŒ ĞĞµÑ‚ conversion analytics

---

## Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ Ğ¸Ğ½Ğ´ÑƒÑÑ‚Ñ€Ğ¸ĞµĞ¹

### Best Practices Ğ¾Ñ‚ Ğ»Ğ¸Ğ´ĞµÑ€Ğ¾Ğ² Ñ€Ñ‹Ğ½ĞºĞ°

#### 1. Two-Sided Incentives (Viral Loops, ReferralRock)

**Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚:** ĞĞ±Ğµ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ÑÑ‚ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñ‹

| ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ | Invitee Reward | Referrer Reward | Energy Planet |
|----------|----------------|-----------------|---------------|
| Dropbox | +500MB | +500MB | âœ… 300â­ + frame |
| Uber | $5 off | $5 credit | âœ… 350â­ |
| Airbnb | $25-55 | $25 | âœ… Revenue share |

**ĞÑ†ĞµĞ½ĞºĞ°:** âœ… Ğ¡Ğ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ best practice

---

#### 2. Tiered Rewards (ReferralRock)

**Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚:** ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ milestone â‰¤ 2 Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ°

| ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ | Tier 1 | Tier 2 | Tier 3 | Energy Planet |
|----------|--------|--------|--------|---------------|
| FantasyDraft | 1 | 3 | 5 | âš ï¸ 1, 5, 15, 30 |
| ReferralCandy | 2 | 5 | 10 | âš ï¸ Gap ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ |

**ĞÑ†ĞµĞ½ĞºĞ°:** âš ï¸ Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ (Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼ĞµĞ¶ÑƒÑ‚Ğ¾Ñ‡Ğ½Ñ‹Ğµ ÑƒÑ€Ğ¾Ğ²Ğ½Ğ¸)

---

#### 3. Gamification (Viral Loops, AppSamurai)

**Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚:** Leaderboards, badges, progress bars, competitions

| Feature | Industry Standard | Energy Planet |
|---------|-------------------|---------------|
| Leaderboard | âœ… Top 100 public | âŒ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ |
| Profile Badges | âœ… Visual status | âŒ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ |
| Progress Bars | âœ… Visual motivation | âš ï¸ Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² UI |
| Season Competitions | âœ… Time-limited | âŒ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ |

**ĞÑ†ĞµĞ½ĞºĞ°:** âŒ ĞĞµ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ (ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»)

---

#### 4. Gameplay Integration (HQ Trivia, WoW)

**Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚:** Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñ‹ ÑĞ²ÑĞ·Ğ°Ğ½Ñ‹ Ñ Ğ¸Ğ³Ñ€Ğ¾Ğ²Ñ‹Ğ¼ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ¼

| Game | Integration | Energy Planet |
|------|-------------|---------------|
| HQ Trivia | Referral = Extra Life | âŒ ĞĞµÑ‚ |
| World of Warcraft | XP Bonus with friend | âŒ ĞĞµÑ‚ |
| Clash of Clans | Co-op rewards | âŒ ĞĞµÑ‚ |

**ĞÑ†ĞµĞ½ĞºĞ°:** âŒ ĞŸĞ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸Ğ·Ğ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ¾Ñ‚ gameplay

---

#### 5. Fraud Prevention (SEON, Fingerprint, Voucherify)

**Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚:** Multi-layer fraud detection

| Ğ¢ĞµÑ…Ğ½Ğ¸ĞºĞ° | Industry Standard | Energy Planet |
|---------|-------------------|---------------|
| Device Fingerprinting | âœ… ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ | âŒ ĞĞµÑ‚ |
| IP Matching | âœ… ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ | âŒ ĞĞµÑ‚ |
| Email Pattern Detection | âœ… ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ | âŒ ĞĞµÑ‚ |
| Velocity Checks | âœ… ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ | âš ï¸ Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ 10/Ğ´ĞµĞ½ÑŒ |
| Delayed Rewards | âœ… ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ | âŒ ĞœĞ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ñ‹Ğµ |
| Minimum Activity | âœ… ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ | âŒ ĞĞµÑ‚ |
| AI/ML Detection | âœ… Ğ–ĞµĞ»Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ | âŒ ĞĞµÑ‚ |

**ĞÑ†ĞµĞ½ĞºĞ°:** âŒ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ™ ĞŸĞ ĞĞ‘Ğ•Ğ› - ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ° Ğ´Ğ»Ñ Ğ¼Ğ¾ÑˆĞµĞ½Ğ½Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ°

---

#### 6. Strategic Timing (GameMarketingGenie, WebEngage)

**Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚:** ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ñ‚ Ğ¿Ğ¾ÑĞ»Ğµ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚Ğ¾Ğ²

| Trigger | Industry Standard | Energy Planet |
|---------|-------------------|---------------|
| After Win | âœ… HQ Trivia, Clash | âŒ ĞĞµÑ‚ |
| After Achievement | âœ… Most games | âŒ ĞĞµÑ‚ |
| After Level Up | âœ… RPGs | âŒ ĞĞµÑ‚ |
| After Rare Drop | âœ… Gachas | âŒ ĞĞµÑ‚ |
| Static Placement | âš ï¸ Low conversion | âœ… Settings/Friends |

**ĞÑ†ĞµĞ½ĞºĞ°:** âŒ Ğ£Ğ¿ÑƒÑ‰ĞµĞ½Ğ½Ğ°Ñ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ (+30-50% conversion)

---

#### 7. Analytics & Optimization (Talkable, Viral Loops)

**Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚:** Deep funnel analytics

| Metric | Industry Standard | Energy Planet |
|--------|-------------------|---------------|
| Viral Coefficient | âœ… K-factor tracking | âŒ ĞĞµÑ‚ |
| Conversion Funnel | âœ… Showâ†’Shareâ†’Activate | âŒ ĞĞµÑ‚ |
| Cohort Analysis | âœ… Retention by source | âŒ ĞĞµÑ‚ |
| LTV Comparison | âœ… Referral vs Organic | âŒ ĞĞµÑ‚ |
| A/B Testing | âœ… Reward structures | âŒ ĞĞµÑ‚ |

**ĞÑ†ĞµĞ½ĞºĞ°:** âŒ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ data-driven optimization

---

### Benchmark Score

```
World of Warcraft (Recruit-A-Friend): 9.5/10
HQ Trivia: 8.5/10
Dropbox: 8.0/10
Energy Planet (Current): 6.5/10
Industry Average: 7.5/10
```

---

## ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹

### ğŸš¨ ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ 1: FRAUD PREVENTION

#### Ğ£ÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ: Fake Accounts

**Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ Ğ°Ñ‚Ğ°ĞºĞ¸:**
```
1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ 30 Ñ„ĞµĞ¹ĞºĞ¾Ğ²Ñ‹Ñ… Telegram Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ²
2. ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚ ĞµĞ³Ğ¾ ĞºĞ¾Ğ´
3. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚:
   - 30 Ã— 350â­ = 10,500â­ (activation rewards)
   - Milestone 1 (1 ref): 500â­
   - Milestone 2 (5 ref): 1,500â­
   - Milestone 3 (15 ref): 3,500â­
   - Milestone 4 (30 ref): 8,000â­

Ğ˜Ğ¢ĞĞ“Ğ: 24,000â­ Ğ·Ğ° ~2 Ñ‡Ğ°ÑĞ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹
```

**Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ±Ğ¸Ğ·Ğ½ĞµÑĞ°:**
- Ğ•ÑĞ»Ğ¸ 1000â­ = $1, Ñ‚Ğ¾ ÑƒĞ±Ñ‹Ñ‚Ğ¾Ğº $24 Ğ½Ğ° Ğ°Ğ±ÑŒÑĞ·ĞµÑ€Ğ°
- ĞŸÑ€Ğ¸ 100 Ğ°Ğ±ÑŒÑĞ·ĞµÑ€Ğ°Ñ… = $2,400 Ğ¿Ğ¾Ñ‚ĞµÑ€ÑŒ
- Ğ˜Ğ½Ñ„Ğ»ÑÑ†Ğ¸Ñ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞ¹ ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸ĞºĞ¸

**Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°:**
```typescript
// backend/src/services/ReferralService.ts:89
// âœ… Ğ•ÑÑ‚ÑŒ:
- Self-referral check
- Daily limit (10/Ğ´ĞµĞ½ÑŒ)
- One code per user

// âŒ ĞĞµÑ‚:
- IP matching
- Device fingerprinting
- Email pattern detection
- Minimum activity requirement
- Delayed rewards
- Manual review queue
```

#### Ğ£ÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ: Race Condition

**Ğ¤Ğ°Ğ¹Ğ»:** `backend/src/services/ReferralRevenueService.ts:69-89`

```typescript
// ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ: ĞœĞµĞ¶Ğ´Ñƒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¾Ğ¹ Ğ¸ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸ĞµĞ¼ Ğ½ĞµÑ‚ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸
const dailySum = await this.sumReferralRevenueSince(...)
// â¬‡ï¸ Ğ”Ñ€ÑƒĞ³Ğ¾Ğ¹ purchase Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¹Ñ‚Ğ¸ Ğ·Ğ´ĞµÑÑŒ
if (dailySum + shareAmount > config.dailyRewardCap) {
  shareAmount = Math.max(0, config.dailyRewardCap - dailySum)
}
// â¬‡ï¸ ĞœĞ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€ĞµĞ²Ñ‹ÑĞ¸Ñ‚ÑŒ cap
await this.grantReward(...)
```

**Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹:**
```
Daily cap: 2000â­
Current sum: 1900â­

Request A: Purchase 200â­ â†’ share 2â­
Request B: Purchase 200â­ â†’ share 2â­

Both check simultaneously:
A: 1900 + 2 < 2000 âœ… (grants 2â­)
B: 1900 + 2 < 2000 âœ… (grants 2â­)

Final sum: 1904â­ > 2000â­ cap âŒ
```

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
```sql
BEGIN TRANSACTION;
SELECT ... FROM referral_revenue_totals
WHERE referral_relation_id = $1
FOR UPDATE; -- Row-level lock

-- Calculate and grant
COMMIT;
```

---

### âš ï¸ ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ 2: DATA INTEGRITY

#### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: ĞĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ

**Ğ¤Ğ°Ğ¹Ğ»:** `backend/migrations/011_referrals.sql:15`

```sql
CREATE TABLE referral_relations (
  ...
  first_purchase_at TIMESTAMP WITH TIME ZONE,
  ...
);
```

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:**
- ĞŸĞ¾Ğ»Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾, Ğ½Ğ¾ ĞĞ˜ĞšĞĞ“Ğ”Ğ Ğ½Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ
- ĞĞµÑ‚ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‰ĞµĞ¹ ÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ»Ğµ
- Dead code Ğ² ÑÑ…ĞµĞ¼Ğµ

**Impact:**
- Ğ‘ĞµÑĞ¿Ğ¾Ğ»ĞµĞ·Ğ½Ğ¾Ğµ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ
- ĞŸĞ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿ÑƒÑ‚Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ²
- ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° "time to first purchase"

#### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: ĞĞµÑ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ¾ÑĞ¼ĞµÑ‚Ğ¸ĞºĞ¸

**Ğ¤Ğ°Ğ¹Ğ»:** `backend/src/services/ReferralService.ts:291`

```typescript
if (reward.cosmetic) {
  const { type, id } = reward.cosmetic
  cosmeticGrants.push({ type, id })
  // âŒ ĞĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ cosmetic
  // âŒ ĞĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ² (ĞµÑĞ»Ğ¸ Ñƒ ÑĞ·ĞµÑ€Ğ° ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ)
}
```

**Ğ Ğ¸ÑĞºĞ¸:**
- ĞÑˆĞ¸Ğ±ĞºĞ¸ Ğ² ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğµ Ğ¿Ñ€Ğ¸Ğ²ĞµĞ´ÑƒÑ‚ Ğº "Ğ½ĞµĞ²Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ğ¼" Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ğ°Ğ¼
- ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ ÑƒĞ·Ğ½Ğ°ĞµÑ‚ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
- ĞĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ failed grants

---

### âš ï¸ ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ 3: PERFORMANCE

#### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: N+1 Queries

**Ğ¤Ğ°Ğ¹Ğ»:** `backend/src/services/ReferralRevenueService.ts:150`

```typescript
async enrichTotalsWithUsers(totals: ReferralRevenueTotal[]) {
  const userIds = new Set<string>()
  totals.forEach(t => userIds.add(t.referred_id))

  // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ batch Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
  const usersMap = await this.loadUsers(Array.from(userIds))

  // âœ… Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾: batch load
  // âš ï¸ ĞĞ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· JOIN Ğ² Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ
}
```

**Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ:**
```
1 query: Get totals (100 rows)
1 query: Get users (100 IDs)
Total: 2 queries

Alternative (JOIN):
1 query: Get totals + users
Total: 1 query (-50% queries)
```

#### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹

**Ğ¤Ğ°Ğ¹Ğ»:** `backend/migrations/014_referral_revenue.sql:23`

```sql
CREATE INDEX idx_referral_revenue_events_referrer
  ON referral_revenue_events(referrer_id);
```

**ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ¸Ğ½Ğ´ĞµĞºÑÑ‹:**
```sql
-- Ğ”Ğ»Ñ daily/monthly cap queries:
CREATE INDEX idx_referral_revenue_events_granted_at
  ON referral_revenue_events(granted_at);

-- Composite Ğ´Ğ»Ñ Ñ‡Ğ°ÑÑ‚Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²:
CREATE INDEX idx_referral_revenue_events_referrer_granted
  ON referral_revenue_events(referrer_id, granted_at DESC);
```

---

### âš ï¸ ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ 4: UX & CONVERSION

#### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ tracking

**Ğ¤Ğ°Ğ¹Ğ»:** `webapp/src/components/settings/ReferralInviteCard.tsx:67`

```typescript
const handleShare = async () => {
  try {
    if (window.Telegram?.WebApp) {
      window.Telegram.WebApp.openTelegramLink(shareUrl)
    }
  } catch (error) {
    // ...
  }
}
// âŒ ĞĞµÑ‚ tracking: share_clicked, method, success/failure
```

**ĞŸĞ¾Ñ‚ĞµÑ€ÑĞ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ:**
- Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ· Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½ ĞºĞ¾Ğ´?
- Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ· clicked share?
- ĞšĞ°ĞºĞ¾Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½ĞµĞµ (Telegram vs Copy)?
- Ğ“Ğ´Ğµ conversion bottleneck?

**Ğ’Ğ¾Ñ€Ğ¾Ğ½ĞºĞ° Ğ±ĞµĞ· Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:**
```
Code Generated â†’ ??? (shown to user?)
                â†’ ??? (share clicked?)
                â†’ ??? (method chosen?)
                â†’ Code Activated
```

#### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: Ğ¡Ñ‚Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ñ€Ğ°Ğ·Ğ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ

**Ğ¤Ğ°Ğ¹Ğ»Ñ‹:**
- `webapp/src/components/settings/SettingsScreen.tsx`
- `webapp/src/screens/FriendsScreen.tsx`

**Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ Ñ€Ğ°Ğ·Ğ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ:**
- Settings ÑĞºÑ€Ğ°Ğ½ (Ğ½Ğ¸Ğ·ĞºĞ¸Ğ¹ engagement)
- Friends ÑĞºÑ€Ğ°Ğ½ (ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾ Ñ€ĞµĞ»ĞµĞ²Ğ°Ğ½Ñ‚Ğ½Ğ¾, Ğ½Ğ¾ Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾)

**Ğ£Ğ¿ÑƒÑ‰ĞµĞ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚Ñ‹:**
- âŒ ĞŸĞ¾ÑĞ»Ğµ Ğ¿Ğ¾Ğ±ĞµĞ´Ñ‹ Ğ² PvP (ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ¸Ğº)
- âŒ ĞŸĞ¾ÑĞ»Ğµ level up (Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ)
- âŒ ĞŸĞ¾ÑĞ»Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ€ĞµĞ´ĞºĞ¾Ğ³Ğ¾ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ğ° (Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ)
- âŒ ĞŸĞ¾ÑĞ»Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ²ĞµÑÑ‚Ğ°
- âŒ First-time user experience (onboarding)

**Impact:**
- Conversion rate: 5-10% (Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹) vs 15-25% (Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼ timing)

---

## ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¸ KPI

### Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ (Ğ¾Ñ†ĞµĞ½Ğ¾Ñ‡Ğ½Ñ‹Ğµ)

```
Acquisition Metrics:
- Referral Code Generation Rate: ~80% (good)
- Share Rate: ~10-15% (low, Ğ½ĞµÑ‚ tracking)
- Activation Rate: ~5-10% (low, Ğ½ĞµÑ‚ timing)
- Viral Coefficient: ~0.3-0.5 (needs improvement)

Quality Metrics:
- Referral Retention D1: ~40% (Ğ¾Ñ†ĞµĞ½ĞºĞ°)
- Referral Retention D7: ~20-30% (Ğ½Ğ¸Ğ·ĞºĞ°Ñ)
- Referral Retention D30: ~10-15%
- Referral LTV: Unknown (Ğ½ĞµÑ‚ tracking)

Fraud Metrics:
- Fraud Rate: ~30-40% (ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ)
- Self-referral blocks: Unknown
- Suspicious patterns: Not detected

Revenue Metrics:
- Revenue Share granted: Unknown
- Daily cap hit rate: Unknown
- Monthly cap hit rate: Unknown
- ROI per referral: Unknown
```

### Ğ¦ĞµĞ»ĞµĞ²Ñ‹Ğµ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ (Ğ¿Ğ¾ÑĞ»Ğµ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ğ¹)

```
Acquisition Metrics:
- Share Rate: 25-35% (+150%)
- Activation Rate: 15-25% (+150%)
- Viral Coefficient: 0.8-1.2 (+160%)

Quality Metrics:
- Referral Retention D7: 40-55% (+80%)
- Referral LTV: Track and optimize
- Organic vs Referral quality: Compare

Fraud Metrics:
- Fraud Rate: 5-8% (-75%)
- Detection accuracy: >95%
- False positive rate: <5%

Revenue Metrics:
- Revenue Share ROI: Positive
- Cap utilization: 70-80%
- Cost per acquisition: <$0.50
```

### Ğ˜Ğ·Ğ¼ĞµÑ€ÑĞµĞ¼Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ)

```sql
CREATE TABLE referral_analytics_events (
  id UUID PRIMARY KEY,
  event_type VARCHAR(50),
  user_id UUID,

  -- Context
  screen VARCHAR(50),          -- Ğ³Ğ´Ğµ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ¾
  trigger VARCHAR(50),         -- Ñ‡Ñ‚Ğ¾ Ğ²Ñ‹Ğ·Ğ²Ğ°Ğ»Ğ¾ (achievement, pvp_win, etc)

  -- Share specific
  share_method VARCHAR(50),    -- telegram, copy, link
  success BOOLEAN,

  -- Timestamps
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ´Ğ»Ñ tracking:**
1. `referral_code_viewed` - ĞºĞ¾Ğ´ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
2. `referral_share_clicked` - Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ° ĞºĞ½Ğ¾Ğ¿ĞºĞ° share
3. `referral_share_success` - share ÑƒÑĞ¿ĞµÑˆĞµĞ½
4. `referral_share_failed` - share failed
5. `referral_code_copied` - ĞºĞ¾Ğ´ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
6. `referral_link_generated` - ÑÑÑ‹Ğ»ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°
7. `referral_prompt_shown` - Ğ¿Ñ€Ğ¾Ğ¼Ñ‚ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½
8. `referral_prompt_dismissed` - Ğ¿Ñ€Ğ¾Ğ¼Ñ‚ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚
9. `referral_leaderboard_viewed` - Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ»Ğ¸Ğ´ĞµÑ€Ğ¾Ğ² Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ°

---

## Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸

### Immediate Actions (Week 1)

#### 1. Basic Fraud Prevention
```typescript
// backend/src/services/ReferralService.ts

interface ActivationContext {
  ipAddress: string
  userAgent: string
  telegramId: bigint
}

async activateReferralCode(
  userId: string,
  code: string,
  context: ActivationContext
): Promise<void> {

  // IP Check
  const referrerIP = await this.getUserLastIP(referrerId)
  if (referrerIP === context.ipAddress) {
    throw new Error('SAME_IP_DETECTED')
  }

  // Velocity check
  const recentActivations = await this.getActivationsByIP(
    context.ipAddress,
    '24 hours'
  )
  if (recentActivations.length >= 3) {
    throw new Error('VELOCITY_LIMIT_EXCEEDED')
  }

  // Continue with existing logic...
}
```

#### 2. Fix Milestone Structure
```json
// backend/content/referrals.json

"milestones": [
  {
    "id": "first_crew",
    "threshold": 1,
    "rewards": {"stars": 300, "cosmetic": {...}}
  },
  {
    "id": "growing_squad",
    "threshold": 3,  // NEW
    "rewards": {"stars": 800}
  },
  {
    "id": "expedition_launch",
    "threshold": 7,  // Changed from 5
    "rewards": {"stars": 2000}
  },
  // ... rest
]
```

#### 3. Add Basic Tracking
```typescript
// webapp/src/services/referrals.ts

export const trackReferralEvent = async (
  eventType: string,
  metadata?: any
) => {
  await fetch('/api/analytics/referral-event', {
    method: 'POST',
    body: JSON.stringify({ eventType, metadata })
  })
}

// Usage:
handleShare() {
  trackReferralEvent('share_clicked', { method: 'telegram' })
  // ... existing logic
}
```

### Short-term (Month 1)

- [ ] Implement delayed rewards (24h review period)
- [ ] Add minimum activity check (5 minutes playtime)
- [ ] Create referral leaderboard UI + backend
- [ ] Add smart placement triggers (post-win, post-achievement)
- [ ] Implement basic analytics dashboard

### Medium-term (Month 2-3)

- [ ] Full fraud detection system with ML
- [ ] Gameplay integration (coop bonuses, clan features)
- [ ] Season competitions with special rewards
- [ ] A/B testing framework for reward structures
- [ ] Advanced analytics with cohort analysis

### Long-term (Month 4+)

- [ ] Gifting system between referrals
- [ ] Referral landing pages
- [ ] Deep social integration
- [ ] Predictive LTV modeling
- [ ] Automated fraud prevention with AI

---

## Benchmark Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ² ĞºĞ¾Ğ½ĞºÑƒÑ€ĞµĞ½Ñ‚Ğ¾Ğ²

| Feature | WoW | HQ Trivia | Dropbox | Energy Planet | Target |
|---------|-----|-----------|---------|---------------|--------|
| Two-sided rewards | âœ… | âœ… | âœ… | âœ… | - |
| Tiered milestones | âœ… | âŒ | âŒ | âœ… | - |
| Revenue share | âŒ | âŒ | âŒ | âœ… | - |
| Fraud prevention | âœ… | âœ… | âœ… | âŒ | âœ… |
| Leaderboards | âœ… | âœ… | âŒ | âŒ | âœ… |
| Gameplay integration | âœ… | âœ… | N/A | âŒ | âœ… |
| Smart timing | âœ… | âœ… | âŒ | âŒ | âœ… |
| Analytics | âœ… | âœ… | âœ… | âŒ | âœ… |
| **Score** | 9/10 | 8.5/10 | 7/10 | **6.5/10** | **8.5/10** |

---

## Appendix

### Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°

```
ĞŸĞ¾Ğ»Ğ½Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ° Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹:

backend/
â”œâ”€â”€ migrations/
â”‚   â”œâ”€â”€ 011_referrals.sql                    # Tables: codes, relations, rewards
â”‚   â””â”€â”€ 014_referral_revenue.sql             # Tables: events, totals
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ ReferralService.ts               # 450 LOC, main logic
â”‚   â”‚   â”œâ”€â”€ ReferralRevenueService.ts        # 280 LOC, revenue share
â”‚   â”‚   â””â”€â”€ ContentService.ts                # Loads referrals.json
â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”œâ”€â”€ ReferralRepository.ts            # 380 LOC, CRUD ops
â”‚   â”‚   â””â”€â”€ ReferralRevenueRepository.ts     # 210 LOC, revenue CRUD
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”‚   â””â”€â”€ ReferralController.ts        # 180 LOC, HTTP handlers
â”‚   â”‚   â””â”€â”€ routes/
â”‚   â”‚       â””â”€â”€ referrals.ts                 # Route definitions
â”‚   â””â”€â”€ __tests__/
â”‚       â””â”€â”€ ReferralRevenueService.spec.ts   # 95 LOC, unit tests
â””â”€â”€ content/
    â””â”€â”€ referrals.json                       # Config (rewards, events, caps)

webapp/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ store/
â”‚   â”‚   â”œâ”€â”€ referralStore.ts                 # Zustand state for referrals
â”‚   â”‚   â””â”€â”€ referralRevenueStore.ts          # Zustand state for revenue
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ referrals.ts                     # API client + mapping
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”‚   â””â”€â”€ ReferralInviteCard.tsx       # Main UI (Settings screen)
â”‚   â”‚   â””â”€â”€ friends/
â”‚   â”‚       â””â”€â”€ ReferralRevenueCard.tsx      # Revenue UI (Friends screen)
â”‚   â””â”€â”€ screens/
â”‚       â”œâ”€â”€ FriendsScreen.tsx                # Integrates ReferralRevenueCard
â”‚       â””â”€â”€ SettingsScreen.tsx               # Integrates ReferralInviteCard

Total LOC: ~1,600 (backend) + ~800 (frontend) = 2,400 LOC
```

### API Endpoints

```
GET  /api/referrals/summary
     â†’ Returns: code, stats, milestones, active events

POST /api/referrals/activate
     Body: { code: string }
     â†’ Activates referral relationship + grants rewards

POST /api/referrals/milestones/:milestoneId/claim
     â†’ Claims milestone reward

GET  /api/referrals/revenue/overview
     â†’ Returns: totals, recent events, available rewards

GET  /api/referrals/top-referrers?limit=100
     â†’ Returns top referrers (for leaderboard)
```

### ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ

```json
// backend/content/referrals.json structure

{
  "rewards": {
    "invitee": { "stars": 300, "cosmetic": {...} },
    "referrer": { "stars": 350 }
  },
  "milestones": [...],
  "revenueShare": {
    "sharePercentage": 0.01,
    "dailyRewardCap": 2000,
    "monthlyRewardCap": 10000
  },
  "limits": {
    "maxActivationsPerReferrerPerDay": 10,
    "maxMilestoneClaimsPerDay": 5
  },
  "events": [...]
}
```

---

**Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½:** 2025-11-16
**Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ review:** ĞŸĞ¾ÑĞ»Ğµ Ğ²Ğ½ĞµĞ´Ñ€ĞµĞ½Ğ¸Ñ Tier 1 ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ğ¹
**ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹:** Engineering Team
