# XP & Progression Overhaul (2025-11-16)

## 0. Статус выполнения
- ✅ Реализована новая XP-кривая и расчёт XP за строительство (`levelV2.ts`, `constructionXp.ts`).
- ✅ Construction Loop: очереди, строители, API `/construction` и `/builders`, интеграция в Session/Tick.
- ✅ Подготовлен миграционный скрипт `scripts/xp-overhaul-migration.ts`.
- ✅ UI обновлён: Progress Banner, OfflineSummaryCard, Builder Panel с покупкой дрона.

## 1. Текущая система (аудит)
- **Кривая опыта.** Порог следующего уровня рассчитывается степенной формулой `100 * level^1.5` до 100 уровня, затем почти линейно до 2000, и далее квадратично без твёрдого лимита (`backend/src/utils/level.ts:1` и `backend/src/utils/level.ts:26`). Внутренний скрипт показал: уровень 20 требует 8 944 XP, уровень 50 — 35 355 XP (совокупно ~725 k), уровень 100 — 100 000 XP за уровень (совокупно 4.05 M), поэтому рост до 100 идёт слишком быстро, а после — слишком полого (см. таблицу ниже).
- **XP из энергии.** Все тап- и пассивные доходы конвертируются в XP по формуле `floor(energy / 10)` (`backend/src/utils/tap.ts:8`). TapService умножает энергию на все активные множители и сразу складывает XP в Redis-буфер (`backend/src/services/TapService.ts:83` + `backend/src/services/TapAggregator.ts:92`). TickService применяет ту же формулу для пассивного дохода до 12 часов офлайна (`backend/src/services/TickService.ts:72`).
- **Покупки/апгрейды зданий.** UpgradeService позволяет купить до 5000 копий за один запрос; каждое приобретение начисляет XP как `cost^0.75` с жёстким капом 40% от следующего уровня для <100 уровней (`backend/src/services/UpgradeService.ts:69`, `backend/src/utils/xp.ts:19`). При уровне 5 покупка Wind Turbine (1 200 энергии) даёт 447 XP — почти половину уровня, а станции более высоких тиров моментально прокачивают по 2–3 уровня.
- **Офлайн-выдача.** При входе в сессию сервис суммирует до 12 часов пассивного дохода с множителем 0.5, начисляет всю энергию и XP одним батчем, и сразу запускает цепочку level-up ( `backend/src/config/index.ts:270`, `backend/src/services/SessionService.ts:134`). UI всегда показывает OfflineSummaryModal, даже если XP=0, но уровень вырос (`webapp/src/store/gameStore.ts:373`).
- **Ограничения по зданиям.** ContentService разрешает до `50 + level*2` копий каждого здания, поэтому к 50 уровню игрок может построить 150 Fusion Core и получить >800 k энерго/сек без каких-либо тормозов (`backend/src/services/ContentService.ts:642`).
- **UX уведомлений.** Любое повышение уровня вызывает полный оверлей (если это «круглый» уровень) плюс отдельный тост на каждый уровень (`webapp/src/App.tsx:209`). Toast-компонент фиксирован шириной ≥280 px, поэтому волна из 10–15 уведомлений перекрывает экран (`webapp/src/components/notifications/Toast.tsx:41`). LevelUpScreen — полноэкранный модал с конфетти и звуками (`webapp/src/components/LevelUpScreen.tsx:1`).
- **Престиж.** Престиж доступен только после уровня 50 и энергии 1e12; сброс обнуляет XP, здания и энергию, но даёт постоянный множитель (`backend/src/services/PrestigeService.ts:13`). Сейчас он не связан с XP-кривой и не решает разгон после 100 уровня.

### 1.1 Данные по текущей кривой (для справки)
| Уровень | XP за уровень | Совокупный XP |
| --- | --- | --- |
| 1 | 100 | 100 |
| 5 | 1 118 | 2 821 |
| 10 | 3 162 | 14 268 |
| 20 | 8 944 | 76 079 |
| 50 | 35 355 | 724 868 |
| 100 | 100 000 | 4 050 120 |
| 150 | 600 000 | 21 800 120 |

### 1.2 Ключевые проблемы
1. **Слишком быстрая прогрессия до 100 уровня.** Любой крупный апгрейд мгновенно добавляет 40% шкалы уровня, а офлайн-доход «сиюминутно» прокачивает по нескольку уровней подряд.
2. **Нет твёрдого лимита уровней и осмысленного эндгейма.** После 100 уровня XP всё ещё капает, но новые здания/бонусы не открываются.
3. **Офлайн-камбэк = шквал попапов.** Сессия выдаёт OfflineSummaryModal и серию LevelUp-тостов сразу после логина, что визуально перегружает и создаёт ощущение «багов».
4. **Монетизация строителей отсутствует.** Все здания строятся мгновенно, поэтому нечего продавать (второго строителя, ускорения и т. п.).
5. **Престиж не связан с XP и не решает разгон — игрок копит множитель пассивно, продолжая фармить XP по старой кривой.

## 2. Внешние ориентиры
- **Гладкая, но медленная кривая уровней.** GameDeveloper пишет, что экспоненциальные кривые стоит выравнивать после mid-game и обязательно иметь понятный кап, чтобы игроки «читали» прогрессию и понимали, куда стремиться.citeturn1search1
- **Таймеры и ограниченные строители.** Классическая модель (Clash of Clans) — постройка занимает время, один строитель доступен сразу, дополнительные покупаются за премиум и ограничивают темп развития.citeturn4view0
- **Строительные таймеры как контроль экономики.** Adam Telfer отмечает, что строительство с таймерами и платой за ускорение балансирует экономику free-to-play и создаёт поводы к монетизации, особенно если в очереди только один строитель.citeturn2search0
- **Престиж в idle-играх.** Современные idle/инкрементальные игры используют престиж как мягкий кап, который переводит постпрогресс в новые ресурсы, но требует ощутимого шага назад.citeturn5search2
- **Продвинутая система престижей.** Специализированные статьи советуют давать за престиж уникальные валюты/будущие бонусы и сопровождать это явными целями, иначе игроки не понимают, зачем сбрасываться.citeturn5search1

## 3. Цели новой системы
1. XP-кап = 100 уровней. Каждые 10 уровней — значимый апгрейд/перки.
2. Основной XP-источник — строительство/апгрейды, а не энергогенерация. XP выдается при завершении строительства.
3. Ввести строительные таймеры и очередь с 1 бесплатным строителем + продаваемым вторым слотом.
4. Престиж становится продолжением прогрессии: после 100 уровня XP превращается в престиж-очки.
5. Офлайн-возврат и уведомления становятся компактными и агрегированными.

## 4. Предлагаемая модель
### 4.1 Кривая XP и лимит уровней
- Диапазон уровней: 1–100. Новая формула: `xp_for_level(level) = round(220 + 35 * level^1.6 + floor(level / 10) * 900)`. Минимум = 200, максимум = 70 000.
- Сводная таблица (полная 
  в `docs/XP/implementation-plan.md`):
  | Уровень | XP за уровень | Совокупный XP |
  | --- | --- | --- |
  | 1 | 255 | 255 |
  | 10 | 1 452 | 8 973 |
  | 30 | 8 943 | 267 452 |
  | 60 | 23 912 | 598 042 |
  | 90 | 49 623 | 1 546 247 |
  | 100 | 70 002 | 2 297 631 |
- После уровня 100 XP складывается в `xp_overflow` и конвертируется в **Prestige Progress** (см. 4.5). Поле `level_cap_reached_at` фиксирует дату получения 100 уровня.
- XP-кап на операцию = 20% текущего уровня (см. `xp_cap_per_action` в новой утилите `levelV2.ts`). Дополнительно: дневной лимит XP из строительств = 1.2 × `xp_for_level(level)`.

### 4.2 Строительство → XP
- XP выдаётся **при завершении** строительства/апгрейда: `xp_reward = tierXP * sqrt(buildTimeMinutes) * (1 + 0.05 * buildingLevel) * quality`. TierXP = {T1:40, T2:90, T3:220, T4:550}.
- `quality` ∈ [0.8;1.15] и зависит от возвращения игрока ±2 минут от завершения таймера или использования ускорителей.
- Каждая покупка создаёт `construction_job` (user_id, building_id, action, tier, duration, builder_slot, xp_reward, energy_cost, metadata). Энергия списывается upfront; доход и XP начисляются после статуса `completed` → `claimed`.
- Перелив XP в `xp_overflow` при капе выполняется сервисом `ConstructionService.completeJob`.

### 4.3 Строители и таймеры
- **Базовый строитель (slot 0)** доступен всем. Время расчёта: `baseTierTime * 1.12^(ownedTier + buildingLevel)` (пример: Solar Panel 5 мин, Fusion Core 2.5 ч, Dyson Node 8 ч).
- **Builder Drone (slot 1)** продаётся за 1 500 Stars или пакетом IAP; даётся 3‑дневный trial после миграции. Слот может быть временным (expires_at) для акционных бустеров.
- Очередь ожидания: до 3 задач. Алгоритм: `queued → running` при освобождении слота. Ускорения разрешены до –80% времени, стоимость = `ceil(duration_min * tierScalar / 12)` Stars.
- Технические сущности: таблицы `builders` и `construction_jobs`, сервисы `ConstructionService` и `BuilderService` (см. раздел 5.1/5.2).

### 4.4 Уровни каждые 10 уровней
- На уровнях 10/20/…/100 игрок выбирает один из трёх перков (см. таблицу в `implementation-plan.md`). Примеры: `Tap Surge (+10% tap income)`, `Passive Harmony (+1% passive multiplier)`, `Efficient Crew (-5% строительного времени)`, `Architect Mind (+5% XP за Tier 3/4)`.
- Ключевые здания теперь жёстко привязаны к этим ступеням (Tier 3 → L30 + перк «Advanced Grid», Tier 4 → L60 + «Futurism Permit»). UI LevelUpScreen показывает выбранный перк вместо общего салюта.

### 4.5 Prestige 2.0
- После L100 XP → Prestige Progress (0–100%). Стоимость престиж-сброса ≈ 2.3M XP экв. + 10B энергии после последнего престижа.
- Награда: +1% мультипликатор и **постоянный строительный буст** (-2% времени) за каждую престиж-рангу. Также выдаём «Prestige Tokens» для косметики/Builder Drone скидок.
- Prestiges теперь связываются с XP-гейтом, а не только с энергией, что соответствует рекомендациям по ясной цели престижей.citeturn5search1turn5search2

### 4.6 Уведомления и офлайн-возврат
- UI заменяет пачку тостов на **Progress Banner**: одно уведомление «+3 уровня (27→30)» с мини-листом открытых перков.
- OfflineSummaryModal сворачивается в карточку (1/3 экрана) с прогресс-баром и кнопкой «Показать детали». LevelUpScreen используется только для перковых уровней (10-кратных) и автозакрывается через 1.5 c.
- NotificationStore агрегирует все level-up события в одну запись (массив уровней) вместо одиночных тостов.

### 4.7 Экономика и баланс
- `xpFromEnergy` переопределяем: `floor(energy / 2500)` и используем только для Battle Pass/ивентов, а не для уровней.
- Passive/Tap энергия теперь влияет на скорость накопления ресурсов для строительства, а не на XP напрямую.
- Новые аналитики: время между уровнями, доля завершённых строительств vs. поставленных, конверсия на Builder Drone.

## 5. План внедрения
### 5.1 Backend
1. **Миграции**
   - `construction_jobs` (статус, builder_slot, speed_multiplier, xp_reward, reward_claimed_at).
   - `builders` (user_id, slot_index, unlocked_at, expires_at).
   - `progress` таблица: добавить `xp_overflow`, `level_cap_reached_at`, `prestige_progress`.
2. **Сервисы**
   - `ConstructionService`: create job, assign builder, tick completion, deliver XP/energy via `completeJob`.
   - Расширить `TickService` — проверяет просроченные работы и автозавершает.
   - Обновить `UpgradeService`: вместо мгновенных апдейтов создавать job, проверять лимиты очереди.
   - `PrestigeService`: новое условие (L100 + energy milestone), расчёт токенов.
3. **XP перерасчёт**
   - Сервис миграции: пересчитать `progress.level/xp` в новый диапазон (например, нормализация по percentiles) и выдать компенсацию Stars за потерянный уровень.
4. **API**
   - Эндпоинты `/construction` (start/cancel/accelerate), `/builders`, `/progression/perk` (выбор перка).
   - `/session` расширить новыми полями: активные строители, очередь работ, prestige_progress.

### 5.2 Frontend
- Новые сторав `constructionStore`, `builderStore` для очереди и ускорений.
- Переработать TapScreen: добавить панель строителя, показывать таймеры.
- Shop → раздел «Builder Drone» с покупкой за Stars или IAP.
- Notifications: внедрить Progress Banner, переписать OfflineSummaryModal на компактную карточку.
- LevelUpScreen → только для узловых уровней + авто-дисмисс.

### 5.3 Тестирование и аналитика
- Юнит-тесты для новой XP-кривой и формулы наград.
- Нагрузочные тесты ConstructionService (много параллельных job completion).
- Трекинг в telemetry: `construction_started`, `construction_completed`, `builder_slot_purchased`, `level_chunk_completed`.

### 5.4 Миграция игроков
1. Снять снапшот прогресса.
2. Пересчитать уровни → новый кап, начислить остаточный XP в `xp_overflow`.
3. Выдать стаки активных построек как «моментально завершённые» задачи, чтобы игроки не потеряли энергию.
4. Всем выдать Builder Drone trial на 3 дня, чтобы объяснить новую механику.

## 6. Открытые вопросы
1. Нужна ли мягкая защита от накопления десятков незавершённых работ при 1 строителе (например, платная автоочередь)?
2. Какую роль будут играть Tap-ивенты / PvP в новой системе (дают ли они строительные ускорители или перковые очки)?
3. Какой объём компенсации Stars выдаём за даунскейл уровней.
4. Требуются ли дополнительные источники XP (например, кампании/квесты) для игроков, которые не любят строить?
