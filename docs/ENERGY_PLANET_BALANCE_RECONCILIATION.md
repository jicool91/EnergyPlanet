# Итоговый аудит баланса Energy Planet (25 октября 2025)

Документ обобщает проверку исходного кода и контент-файлов, сопоставляет их с внутренними анализами (`BALANCE_ANALYSIS_vs_BEST_PRACTICES.md`, `GAME_BALANCE_SUMMARY.md`, `IDLE_GAME_DESIGN_BEST_PRACTICES.md`) и актуальными best practices в жанре idle/инкрементальных игр. Цель — зафиксировать реальные формулы, выявить расхождения и предложить план выправления экономики до запуска MVP.

---

## 1. Краткое резюме
- **Престиж-цикл** реализован: POST `/prestige` сбрасывает прогресс и накапливает множитель `+floor((energy_since_prestige / 1e12)^{1/3})`.
- **Экономика зданий** обновлена: апгрейды используют кусочно-экспоненциальную формулу с софт-кэпом после 25 уровня (1.20/1.22/1.24/1.26 → 1.10/1.12/1.14/1.16).
- **XP экономика** смягчена: кап 40 % → 33 % → 28 % → 25 %, демпфер (`base=400`, `exponent=1.3`).
- **Бусты** синхронизированы с контентом: реклама ×1.8 на 10 мин с кулдауном 30 мин, daily ×1.5 на 15 мин, premium ×2.5.

Основные приоритеты теперь:
1. Мониторинг престижных метрик и UX подсказок для первого сброса.
2. Плейтесты тира 3–4 на новых мультипликаторах.
3. Аналитика XP/кап, чтобы убедиться, что прогресс 300+ уровней остаётся комфортным.
4. Боевой план по косметике/ачивкам и сезонкам.

---

## 2. Фактические параметры в коде

### 2.1 Tap и пассивный доход
- Формула одного тапа: `1 × (1 + 0.15 × tapLevel)` (`backend/src/utils/tap.ts:1`–`backend/src/utils/tap.ts:8`).  
- Пассивный доход: `base_income × count × (1 + level × upgrade_income_bonus)` (`backend/src/services/passiveIncome.ts:38`–`backend/src/services/passiveIncome.ts:59`).
- Активные бусты множатся: и в `TapService`, и в пассивном снэпшоте используется `reduce((acc, boost) => acc * boost.multiplier)` (`backend/src/services/TapService.ts:58`–`backend/src/services/TapService.ts:85`, `backend/src/services/passiveIncome.ts:55`–`backend/src/services/passiveIncome.ts:74`).

### 2.2 Стоимость зданий и апгрейдов
- Покупка: `base_cost × cost_multiplier^count`, мультипликатор зависит от тира (1.12 → 1.15) (`content/items/buildings.json`, `backend/src/services/ContentService.ts:168`–`backend/src/services/ContentService.ts:205`).
- Апгрейд: кусочно-экспоненциальная формула (`backend/src/services/ContentService.ts:205`–`backend/src/services/ContentService.ts:218`):
  - уровни 0–25: множители 1.20 (тир 1), 1.22 (тир 2), 1.24 (тир 3), 1.26 (тир 4);
  - уровни 26+: накопленный множитель × 1.10 / 1.12 / 1.14 / 1.16 для тиров 1–4.
- Пример стоимости апгрейда до уровня 30:
  - Solar Panel: 384 091 E  
  - Geothermal Plant: 10 165 901 E  
  - Nuclear Reactor: 312 699 833 E  
  - Quantum Generator: 84 813 226 880 E  
  *(расчёт по обновлённому `content/items/buildings.json`).*

### 2.3 Прогрессия XP
- Порог уровня: экспонента 1.5 до 100, затем линейный и квадратичный отрезки (`backend/src/utils/level.ts`).
- Кап на XP из транзакций: динамический (40 % < 100 lvl, 33 % на 100–299, 28 % на 300–599, 25 % после 600) — см. `backend/src/utils/xp.ts`.
- Демпфер: `1 / (1 + (level / 400) ^ 1.3)` — снижает raw XP мягче, чем прежняя настройка.
- Пример (покупка на 1 000 000 E):
  - L30: кап 6 572 XP, применяется 6 572 XP (≈8 % raw).
  - L100: кап 33 000 XP, применяется 33 000 XP (≈39 % raw).
  - L300: кап 588 000 XP, применяется 50 603 XP (≈59 % raw).
  - L750: кап 1 650 000 XP, применяется 26 168 XP (≈31 % raw).

### 2.4 Бусты и античит
- Настройки бустов берутся из `content/flags/default.json`: рекламный ×1.8 на 600 c (10 мин) с кулдауном 1800 c (30 мин), daily ×1.5 на 900 c, premium ×2.5 (1ч/24ч/7д) с кулдауном 24 ч (`backend/src/services/BoostService.ts`).
- `BoostService` при выдаче очищает активные бусты только при престиже (через `clearBoostsForUser`).
- Античит по тапам: 30 tps и 600 taps/min (`backend/src/services/TapService.ts`).

## 3. Сопоставление с best practices
| Блок | Фактическое состояние | Статус | Комментарий |
|------|-----------------------|--------|-------------|
| Tap / Passive | 0.15 / 0.20 множители, престиж + бусты множатся | ✅ | Соответствует Kongregate/GDC рекомендациям |
| Upgrade cost | 1.20→1.26 до 25 lvl, 1.10→1.16 после | ✅ | Мягкая экспонента предотвращает стену |
| XP кап | 40→33→28→25 %, демпфер 1/(1+(lvl/400)^1.3) | ✅ | Входит в коридор 30–50 % |
| Boosts | Ad ×1.8, daily ×1.5, premium ×2.5 | ⚠️ | Нужен мониторинг монетизации |
| Prestige | POST /prestige, множитель растёт по энергии | ✅ | Требуется телеметрия |

## 4. Документы/код к обновлению
1. `BALANCE_ANALYSIS_vs_BEST_PRACTICES.md` и `GAME_BALANCE_SUMMARY.md` синхронизированы; при дальнейших правках обновлять таблицы.
2. Клиент (`webapp`) отображает престиж-карту и читает новые поля (`prestige_level`, `prestige_multiplier`) — провести UX-тест с игроками.
3. Контент `content/items/buildings.json` и `content/flags/default.json` обновлены; не забывать зеркалировать в `backend/content_new/**`.

## 5. Следующие шаги
1. **Плейтесты** длинных прогонов (5+ престижей) и сбор фидбека по темпу.
2. **Телеметрия**: добавить события `prestige_available`, `prestige_skip`, `prestige_performed` с энергией и множителем.
3. **Монетизация бустов**: измерить ARPDAU после новых значений ×1.8/кулдаун 30 мин; скорректировать при необходимости.
4. **Косметика/ачивки** за `prestige_level` — подготовить контент и UI.
5. **Документация**: поддерживать `IDLE_GAME_DESIGN_BEST_PRACTICES.md` и `GDD.md` в актуальном состоянии после баланс-патчей.

## 6. Метрики для контроля
- Время до первого престижа и средний множитель после N циклов.
- Распределение трат энергии на апгрейды (проверка, что софт-кэп не ломает ROI).
- Конверсия ad boost → premium boost после изменений.
- Жалобы/тикеты на XP-кап и темп прокачки 300+ уровней.
- ARPDAU и удержание (D1/D7/D30) в сравнении с прошлой версией.
