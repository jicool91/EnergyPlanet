# Webapp Performance Improvement Plan

**Приложение:** Energy Planet (webapp)
**Дата:** 26 октября 2025
**Контекст:** после рефакторинга разметки выявлены повторные перерисовки и тяжёлые состояния при высоких частотах обновления (энергия, пассивный доход).

---

## 1. Наблюдаемые симптомы

- Energy/XP обновляются каждую секунду → перерендер `App` и цепочки `MainScreen → HomePanel → Card`.
- Анимационные компоненты (`LevelBar`, shimmer в `XPProgressCard`, кнопка Tap) всегда активны, даже когда элемент вне вьюпорта.
- Магазин и Постройки используют большие списки карточек, которые пересчитываются при каждом обновлении Zustand-хранилища.

---

## 2. Быстрые победы (до 1 часа)

1. **Мемоизировать «тяжёлые» view-компоненты** — ✅ выполнено 26.10.2025  
   `MainScreenHeader`, `LevelBar`, `StatCard`, `BuildingCard` переведены на `React.memo`, в `MainScreen` и `ShopPanel` применены селекторы с `shallow`.

2. **Отключать анимации вне вьюпорта** — ✅ выполнено 26.10.2025  
   `LevelBar` и `XPProgressCard` используют `IntersectionObserver` и `useReducedMotion`, shimmer отключается, когда компонент скрыт.

3. **Расчёт «подсказок» вынести за рендер** — ✅ выполнено 26.10.2025  
   План покупок вынесен в view-model, мемоизация построек реализована в отдельном модуле.

---

## 3. Среднесрочные задачи (1–3 часа)

1. **Декомпозировать глобальные подписки** — ✅ выполнено 26.10.2025  
   `MainScreen`, `ShopPanel` и смежные компоненты используют узкие селекторы и `shallow`, производные данные вычисляются через `useMemo`.

2. **Разделить Zustand-хранилище** — ✅ выполнено 26.10.2025  
   Создан отдельный `catalogStore` для статичных данных, включён `subscribeWithSelector`.

3. **Оптимизировать списки** — ✅ выполнено 26.10.2025  
   Стабилизированы обработчики и внедрена виртуализация (`react-virtuoso`) для каталога построек.

---

## 4. Структурные улучшения (1 день)

1. **Создать слой view-model** — ✅ выполнено 26.10.2025  
   Добавлены `buildBuildingsViewModel` и `buildShopViewModel`, компоненты потребляют подготовленные данные.

2. **Ввести троттлинг энергий** — ✅ выполнено 26.10.2025  
   В `gameStore` пассивные обновления буферизуются с шагом 250 мс, UI-коммит происходит пачками.

3. **Покрыть производительность тестом** — ✅ выполнено 26.10.2025  
   Playwright-сценарий `npm run test:perf` отслеживает FPS и количество рендеров в tap-loop, результаты зафиксированы в отчёте.

---

## 5. Контрольный список

- [x] `React.memo` на `MainScreenHeader`, `LevelBar`, `BuildingCard`.
- [x] Селектор Zustand + `shallow` для каждого компонента.
- [x] Выключение shimmer-анимаций при `prefers-reduced-motion` и вне вьюпорта.
- [x] Мемоизация списка построек и косметики (map/filter → useMemo).
- [x] Вынос расчётов ROI и `purchaseInsight` в сервисы.
- [x] Playwright сценарий «tap loop» с проверкой плавности.

---

## 6. Дополнительно

- ✅ Таблица метрик (FPS, CPU, memory) перенесена в `docs/ui-analysis/reports/performance/2025-10-26-tap-loop-benchmark.md`.
- ✅ В бэклог добавлена задача «[performance] CI Benchmarks» с тегом `performance`.
