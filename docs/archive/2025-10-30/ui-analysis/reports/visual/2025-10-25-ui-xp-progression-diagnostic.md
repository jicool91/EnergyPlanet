# 2025-10-25 Диагностика UI ✕ XP-прогрессии

Документ обновляет промпт для UI-аудита Telegram Mini App, фиксирует результаты симуляций XP по живым формулам проекта и агрегирует внешние best practices по балансировке idle/кликер-прогрессий. Итог — дорожная карта, как вернуть баланс между добычей энергии, покупкой зданий и ростом уровней.

## 1. Промпт и методика

### 1.1 Контекст и роль
- Роль: ведущий UI/UX- и эконом-дизайнер Telegram Mini App с XP-прогрессией.
- До анализа собираем артефакты: пользовательские флоу, свежие скриншоты, телеметрию XP/энергии, таблицы экономики и сезонных множителей. 
- Привязываем оценку к целям пользователя и гипотезам релиза, чтобы выводы сразу укладывались в дорожную карту. 

### 1.2 Обзор поверхностей и взаимодействий
- Трёхпроходный осмотр (структура → взаимодействие → микрокопия) по мотивам эвристического аудита Нильсена. 
- Каждую находку ранжируем по P0–P3 (серьёзность × охват), чтобы backlog сразу был приоритизирован.
- Проверяем визуальную согласованность, ритм отступов, touch-зоны, контраст и соответствие светлой/тёмной теме Telegram.

### 1.3 Обратная связь и прогрессия
- Трассируем, что игрок видит при изменении XP: дельта, прогресс до уровня, источник награды, пост-левел бонусы.
- Сравниваем дельту XP с порогом текущего уровня, чтобы UI не вводил игрока в заблуждение скачками. 
- Проверяем состояния пусто/загрузка/ошибка/резкий прирост — крупные награды не должны ломать макет и снижать доверие.

### 1.4 Телеметрия и эксперименты
- До визуальных выводов убеждаемся, что аналитика покрывает события, параметры и воронки — эвристика усиливается данными. 
- Логируем каждую дельту XP с источником (тап, постройка, достижение, буст), чтобы автоматически ловить runaway-мультипликаторы.

## 2. Факты и риски (состояние на 25.10.2025)

### 2.1 Пробелы в текущем UI-анализе
- Промпт `docs/ui-analysis/prompts/UI_ANALYSIS_PROMPT.md` не проверяет экономику: видимость XP-дельт, темп наград, переполнения счётчиков.
- Нет связки «визуальная находка → телеметрия/баланс», поэтому правки UI могут выходить без валидации экономики.
- Не хватает каталога артефактов (скриншоты, записи, логи XP), затрудняется повторяемость аудита.

### 2.2 Симуляции XP
Формулы из кода (`backend/src/utils/level.ts`, `backend/src/utils/tap.ts`, `backend/src/services/ContentService.ts`, `backend/src/services/UpgradeService.ts`) перенесены в Node-скрипт. Сезонный множитель XP: +20 %.

#### Пороговые значения
| Уровень | XP до следующего |
| --- | --- |
| 100 | 100 000 |
| 200 | 1 100 000 |
| 500 | 4 100 000 |
| 750 | 6 600 000 |
| 1 000 | 9 100 000 |
| 1 100 | 14 100 000 |
| 1 200 | 19 100 000 |

#### 500 тапов (сезонный буст +20 %)
| Когорта | Порог XP | tapLevel | Энергия/тап | XP за 500 тапов | Доля порога |
| --- | --- | --- | --- | --- | --- |
| 50 | 35 355 | 5 | 1,75 | 105 | 0,30 % |
| 200 | 1 100 000 | 20 | 4,00 | 240 | 0,02 % |
| 1 000 | 9 100 000 | 100 | 16,00 | 960 | 0,01 % |
| 1 200 | 19 100 000 | 120 | 19,00 | 1 140 | 0,01 % |

#### Покупка Dyson Sphere Node
| Порядковый номер | Стоимость | XP | Эквивалент уровней @ 1 200 |
| --- | --- | --- | --- |
| 1 | 5 000 000 | 250 000 | 0,013 |
| 31 | 331 058 860 | 16 552 943 | 0,87 |
| 41 | 1 339 317 732 | 66 965 886 | 3,51 |
| 51 | 5 418 287 208 | 270 914 360 | 14,18 |
| 76 | 178 364 339 878 | 8 918 216 993 | 467 |
| 101 | 5 871 567 253 502 | 293 578 362 675 | 15 371 |

#### Покупка Quantum Generator
| Порядковый номер | Стоимость | XP | Эквивалент уровней @ 1 200 |
| --- | --- | --- | --- |
| 1 | 25 000 000 | 1 250 000 | 0,065 |
| 31 | 1 655 294 299 | 82 764 714 | 4,33 |
| 51 | 27 091 436 040 | 1 354 571 802 | 70,92 |
| 76 | 891 821 699 390 | 44 591 084 969 | 2 335 |
| 101 | 29 357 836 267 507 | 1 467 891 813 375 | 76 853 |
| 151 | 31 813 837 740 087 216 | 1 590 691 887 004 360 | 83 282 298 |
| 201 | 34 475 302 012 389 940 000 | 1 723 765 100 619 497 000 | 90 249 481 708 |

**Вывод:** тап-луп после 200 уровня почти не двигает прогресс, а поздние покупки мгновенно дают десятки/тысячи уровней. Одно неверное изменение множителей делает «миллионные уровни» массовой ситуацией.

### 2.3 Дополнительные риски
- `TapAggregator` сбрасывает крупные партии XP одним событием — UI не успевает показать переходы.
- UI не имеет сценария staged level-up (pre → level-up → post reward); игрок может пропустить награду.
- Форматирование чисел >9 знаков не адаптировано, HUD и модалки рискуют переполниться.

## 3. Чек-лист на следующую сессию

### UI
- Новые скринкасты XP-флоу (тап, покупка, бусты, достижения) в светлой/тёмной теме Telegram.
- Прогнать обновлённый промпт, занести проблемы в P0–P3-трекер.
- Проверить типографику, контраст и автоформат чисел в XP-bar, модалках и чипах статистики.

### Экономика и баланс
- Зафиксировать baseline XP/час для когорт 50/200/1000/1200.
- Подготовить варианты ограничений: cap XP за транзакцию, убывающая отдача после N-й покупки, staged очередь level-up. 
- Проверить влияние сезонных множителей (+20 %) и редких ивентов; при необходимости вынести правки в контент.

### Телеметрия и алерты
- Добавить события: `xp_transaction_raw`, `xp_transaction_applied`, `source_type`, `level_before`, `level_after`, `anomaly_flag`.
- Настроить алерт: если транзакция даёт >25 % порога или >5 уровней у игрока 500+ уровня — флаг в Slack/Telegram.
- Синхронизировать UI-инструментацию (аналитика, Sentry breadcrumbs) с серверными событиями.

## 4. Ответственные и зависимости
- **Бэкенд (прогрессия):** внедрить ограничители XP, API для staged-анимаций.
- **Эконом-дизайн:** обновить кривые, множители, сценарии late-game; сверить с сезонными KPI.
- **Фронтенд/UI:** разработать UX множественных level-up (очередь, квитанции) и адаптивное форматирование больших чисел.
- **Аналитика:** расширить схему событий, обновить дешборды, настроить ежедневную sanity-проверку прогрессии.

## 5. Внешние практики и выводы
- **Скарcity наград.** Избыток наград обесценивает их; лучше делать награды осмысленными и редкими, чтобы игрок считывал ценность. 
- **Meaningful choices.** Слишком много/мало наград одинаково вредно; важно ограничивать пассивный доход и поддерживать выбор игрока. 
- **Моделирование перед выкатом.** Прогрессии стоит тестировать в симуляциях до релиза, чтобы избежать runaway-эффекта. 
- **Эволюционные симуляции экономики.** Небольшие изменения параметров требуют итераций и fitness-функций; без автоматизации легко пропустить дисбаланс. 
- **Лимиты idle-дохода.** Успешные Idle-проекты ограничивают оффлайн-награды, чтобы игрок возвращался до «потолка». 

## 6. Предлагаемые изменения баланса
1. **Cap на XP-транзакции.**
   - `TRANSACTION_XP_CAP = 0.25 * xpThresholdForLevel(level)` — жёстко ограничивает XP с одной покупки/апгрейда.
   - Поверх кэпа применять функцию убывающей отдачи: `diminish(level) = 1 / (1 + (level / 250)^{1.6})`. Для 1000+ уровня итоговая награда ≤1–2 уровней.
2. **Новая формула для покупок/апгрейдов.**
   - Тапы/пассивный доход оставить на `xpFromEnergy(energy)`.
   - Для покупок использовать: `purchaseXp = floor((cost)^{0.75} * A)`. Подбор `A`: покупка #1 ≈5 % порога, #30 ≤20 %, #50 ≤25 % (до кэпа).
   - Для апгрейдов взять степень 0.70 и отдельный коэффициент `A_upgrade`, чтобы апгрейды были дешевле в XP, чем покупки.
3. **Обновление `xpThresholdForLevel`.**
   - Диапазон 1000–2000: увеличить шаг до +150 000 XP.
   - 2000+: квадратичная формула `B * (level - 1800)^2`, чтобы endgame-награды требовали нового контента, а не старых действий.
4. **Анти-спайки в TapAggregator.**
   - Если XP-пакет >10 % порога, дробить его на чанки по 2 % и шлёпать в очередь в течение 1–2 секунд.
   - Логировать дробление (`xp_original`, `chunks`, `chunk_value`), чтобы аналитика видела реальные пики.
5. **Late-game синки.**
   - Добавить расход XP на сезонные миссии/ивенты, чтобы избыток XP конвертировался в полезные активности.
   - Ввести «overflow XP»: после кэпа избыточный опыт превращается в временную валюту (например, для косметики) вместо уровней.

## 7. План внедрения
1. **Эконометрика.** Подготовить симулятор по мотивам GEEvo: 1000+ сценариев с реальными событиями, подбор коэффициентов `A`/`TRANSACTION_XP_CAP`.
2. **Телеметрия.** До выката — добавить события `xp_transaction_raw`, `xp_transaction_applied`, `level_delta`, `source_type`, `is_capped`.
3. **Эксперимент.** Запустить A/B `xp_balancing_v2` (10 % трафика), мерить retention/ARPU/долю игроков с >5 уровней за транзакцию.
4. **UI-UX.** Спроектировать staged level-up (очередь наград, квитанции) и компонент форматирования больших чисел (например, `formatLargeValue` с короткими суффиксами).
5. **Документация.** После утверждения коэффициентов обновить GDD, контент (`content/items/buildings.json`) и README по экономике; добавить раздел о мониторинге прогрессии.
