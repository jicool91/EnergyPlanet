# Анализ системы XP в Energy Planet
## Выявленные проблемы с балансом прогрессии

**Дата:** 29 октября 2025
**Статус:** Потребует рефакторинга
**Критичность:** ВЫСОКАЯ

---

## 1. ОБЗОР ПРОБЛЕМЫ

Игрок сообщает, что после менее чем суточной неактивности уровень скачет на ~782, что указывает на серьёзный дисбаланс в системе расчёта опыта. Исследование кодовой базы выявило множество взаимосвязанных проблем, которые вместе создают "идеальный шторм" для экспоненциального роста уровня.

**Текущая ситуация:**
- Новый игрок легко достигает уровней 700+ за короткое время
- Офлайн прирост за ночь скачивает уровень на сотни пунктов
- Достижения при открытии профиля могут дать сразу несколько уровней
- Покупка больших зданий скачивает уровень значительно

---

## 2. ИСТОЧНИКИ XP И ИХ ВКЛАД

### 2.1 Основная формула преобразования энергии в XP

**Файл:** `backend/src/utils/tap.ts`

```typescript
export function xpFromEnergy(energy: number): number {
  return Math.floor(energy / 10);
}
```

**Проблема:** Это базовое преобразование, которое умножается на **4 множителя**:
1. `boostMultiplier` - активные бусты
2. `prestigeMultiplier` - множитель престижа (начинается с 1.0)
3. `achievementMultiplier` - множитель достижений (начинается с 1.0)
4. Множители отдельных источников дохода

**Вывод:** На деле энергия → XP преобразуется не как `energy / 10`, а как `(energy / 10) * boost * prestige * achievement`

---

### 2.2 Офлайн прирост (THE BIGGEST PROBLEM)

**Файл:** `backend/src/services/SessionService.ts`

```typescript
const offlineSecondsRaw = secondsBetween(progress.lastLogout, now);
const maxOfflineSeconds = config.session.maxOfflineHours * 3600;  // 12 часов!
const offlineSeconds = Math.min(offlineSecondsRaw, maxOfflineSeconds);

const offlineEnergy = Math.floor(
  effectiveIncome * offlineSeconds * 0.5  // 50% от пассивного дохода
);
const offlineXp = xpFromEnergy(offlineEnergy);  // Затем конвертится в XP
```

**Проблема 1: Максимум 12 часов офлайн**

Если игрок не входил ночью (8-10 часов), это приемлемо. Но если выходные или отпуск - за 12 часов может сгенерироваться колоссально много энергии.

**Расчёт для примера:**
- Пассивный доход: 100K энергии/сек (примерный средний)
- Офлайн время: 12 часов = 43,200 сек
- Офлайн множитель: 0.5x
- **Офлайн энергия = 100K × 43,200 × 0.5 = 2.16e9 энергии**
- **Офлайн XP = 2.16e9 / 10 = 216 миллионов XP**

При наличии множителей (prestige + achievement), это может быть **500+ миллионов XP за ночь**.

**Проблема 2: Офлайн XP применяет ВСЕ множители**

```typescript
const totalMultiplier = boostMultiplier * prestigeMultiplier * achievementMultiplier;
const boostedEnergy = offlineEnergy * totalMultiplier;
const xpGained = xpFromEnergy(boostedEnergy);
```

Это означает, что офлайн прирост **не ограничен** множителями прогрессии. Если у игрока есть:
- Prestige x5 (от 5 престижей)
- Achievement x1.23 (от всех достижений)
- Boosts (активные бусты)

То офлайн энергия умножается на **5 × 1.23 = 6.15**, а это ~6x увеличение!

**ВЫВОД:** Это основная причина скачков на 700+ уровней за ночь.

---

### 2.3 Множитель престижа (Экспоненциальный рост)

**Файл:** `backend/src/services/PrestigeService.ts`

```typescript
const PRESTIGE_MILESTONE = 1_000_000_000_000; // 1e12 энергии

function computePrestigeGain(energySinceSnapshot: number): number {
  const ratio = energySinceSnapshot / PRESTIGE_MILESTONE;
  const raw = Math.pow(ratio, 1 / 3);  // КУБИЧЕСКИЙ КОРЕНЬ!
  return Math.floor(raw);
}
```

**Проблема 1: Кубический корень для несколько стабильного роста**

После первого престижа (когда нужно 1e12 энергии), каждый следующий престиж требует ещё больше:

| Престиж | Энергия от предыдущего | Множитель |
|---------|----------------------|-----------|
| 1 | 1e12 | 1.0 → +1 |
| 2 | 8e12 | 2.0 → +2 |
| 3 | 27e12 | 3.0 → +3 |
| 4 | 64e12 | 4.0 → +4 |
| 5 | 125e12 | 5.0 → +5 |

Если игрок достиг 5 престижей, престиж-множитель = 1 + 1 + 2 + 3 + 4 + 5 = **16.0x** на всех источниках XP!

**Проблема 2: Нет верхнего ограничения**

Престиж-множитель может расти бесконечно. На высоких уровнях игрок с 50 престижами будет иметь множитель **~1275x**.

**ВЫВОД:** Это создаёт экспоненциальный эффект: офлайн доход с mult 6x + prestige mult 16x = 96x общий множитель на XP.

---

### 2.4 Множитель достижений (Скрытый множитель)

**Файл:** `backend/src/services/AchievementService.ts` и миграция `008_achievements_system.sql`

Достижения дают постоянные множители к энергии:

```sql
-- Energy Tycoon (5 уровней)
(SELECT id FROM energy), 1, 1e5, 1.02,   -- Level 1: ×1.02
(SELECT id FROM energy), 2, 1e7, 1.04,   -- Level 2: ×1.04
(SELECT id FROM energy), 3, 1e9, 1.06,   -- Level 3: ×1.06
(SELECT id FROM energy), 4, 1e12, 1.08,  -- Level 4: ×1.08
(SELECT id FROM energy), 5, 1e15, 1.10,  -- Level 5: ×1.10

-- Tap Maestro (5 уровней)
(SELECT id FROM taps), 1, 1e3, 1.01,
(SELECT id FROM taps), 2, 1e4, 1.02,
(SELECT id FROM taps), 3, 1e5, 1.03,
(SELECT id FROM taps), 4, 5e5, 1.05,
(SELECT id FROM taps), 5, 1e6, 1.07,

-- Builder Guild (5 уровней)
(SELECT id FROM build), 1, 10, 1.01,
(SELECT id FROM build), 2, 50, 1.02,
(SELECT id FROM build), 3, 150, 1.03,
(SELECT id FROM build), 4, 400, 1.04,
(SELECT id FROM build), 5, 800, 1.05,

-- Prestige Voyager (5 уровней)
(SELECT id FROM prestige), 1, 1, 1.02,
(SELECT id FROM prestige), 2, 3, 1.03,
(SELECT id FROM prestige), 3, 6, 1.04,
(SELECT id FROM prestige), 4, 10, 1.05,
(SELECT id FROM prestige), 5, 15, 1.06,
```

**Проблема 1: Множители умножаются, не складываются**

```typescript
function computeClaimedMultiplier(definition, currentTier) {
  return definition.tiers
    .filter(t => t.tier <= currentTier)
    .reduce((acc, tier) => acc * tier.rewardMultiplier, 1);  // УМНОЖЕНИЕ!
}
```

Полученный множитель за все достижения:
- Energy Tycoon: 1.02 × 1.04 × 1.06 × 1.08 × 1.10 = **1.315** (31.5% бонус)
- Tap Maestro: 1.01 × 1.02 × 1.03 × 1.05 × 1.07 = **1.194** (19.4% бонус)
- Builder Guild: 1.01 × 1.02 × 1.03 × 1.04 × 1.05 = **1.160** (16% бонус)
- Prestige Voyager: 1.02 × 1.03 × 1.04 × 1.05 × 1.06 = **1.233** (23.3% бонус)

**Общий множитель достижений = 1.315 × 1.194 × 1.160 × 1.233 = ~2.36x**

**Проблема 2: Нет верхнего ограничения**

Достижения могут добавляться в БД постоянно. Нет механизма, который ограничивает общий множитель.

**Проблема 3: Синхронизация может произойти много раз**

```typescript
async claimNextTier(userId: string, slug: string) {
  const newMultiplier = (progress.achievementMultiplier ?? 1) * tier.rewardMultiplier;
  await updateProgress(userId, { achievementMultiplier: newMultiplier }, client);
}
```

Каждое открытие профиля может вызвать `syncMetric()` для всех достижений, что может мгновенно разблокировать и заклеймить несколько уровней:

```typescript
async syncMetric(userId, metric, progressValue, client) {
  for (const def of definitions) {
    const highestUnlocked = computeHighestUnlocked(def, progressValue);
    // Может разблокировать tier 2, 3, 4, 5 ВСЕ ЗА РАЗ!
  }
}
```

**ВЫВОД:** Достижения добавляют ещё ~2.36x множитель, что вместе с офлайном и престижем дает **6 × 16 × 2.36 = ~226x общий множитель на XP за ночь**.

---

### 2.5 XP от покупки зданий (Скрытый источник XP)

**Файл:** `backend/src/utils/xp.ts`

```typescript
const PURCHASE_XP_EXPONENT = 0.75;
const PURCHASE_XP_COEFFICIENT = 2.7011479041326116;

export function calculatePurchaseXp(cost: number, level: number): TransactionXpComputation {
  const baseXp = Math.pow(cost, PURCHASE_XP_EXPONENT) * PURCHASE_XP_COEFFICIENT;
  return computeWithCap(baseXp, level);
}
```

**Проблема 1: Покупка одного дорогого здания дает много XP**

Примеры:
- Здание стоимостью 1M: `(1e6)^0.75 × 2.7 = 1.93M XP`
- Здание стоимостью 1B: `(1e9)^0.75 × 2.7 = 69.8M XP`
- Здание стоимостью 1T: `(1e12)^0.75 × 2.7 = 2.54B XP`

Затем применяется cap в зависимости от уровня.

**Проблема 2: Cap слишком высокий на ранних уровнях**

```typescript
function transactionCapRatio(level: number): number {
  if (level < 100) return 0.4;      // 40% порога уровня!
  if (level < 300) return 0.33;     // 33% порога уровня
  if (level < 600) return 0.28;     // 28% порога уровня
  return 0.25;                       // 25% порога уровня
}
```

На уровне 50, порог XP = 177,827 (из формулы `100 * 50^1.5`). Cap = 177,827 × 0.4 = **71,131 XP за одну покупку**.

Это означает, что покупка одного дорогого здания может дать почти целый уровень!

**Проблема 3: Затухание слишком слабое**

```typescript
function diminishingMultiplier(level: number): number {
  const normalized = level / 400;
  return 1 / (1 + Math.pow(normalized, 1.3));
}

// Примеры:
// Level 50: 1 / (1 + 0.125^1.3) = 0.93 (93% от базового)
// Level 100: 1 / (1 + 0.25^1.3) = 0.82 (82% от базового)
// Level 400: 1 / (1 + 1^1.3) = 0.5 (50% от базового)
// Level 800: 1 / (1 + 2^1.3) = 0.22 (22% от базового)
```

На уровне 50 игрок всё ещё получает 93% от XP покупок. Затухание начинает работать эффективно только после уровня 200.

**ВЫВОД:** Покупка зданий дает скрытый источник XP, который не ограничен до уровня 200+.

---

### 2.6 Система уровней (Недостаточное увеличение сложности)

**Файл:** `backend/src/utils/level.ts`

```typescript
const BASE_XP_MULTIPLIER = 100;
const BASE_EXPONENT = 1.5;
const MID_SOFT_CAP_LEVEL = 100;
const HIGH_SOFT_CAP_LEVEL = 1000;
const LATE_SOFT_CAP_LEVEL = 2000;

const MID_INCREMENT = 10_000;
const HIGH_INCREMENT = 150_000;
const LATE_QUADRATIC_COEFFICIENT = 200_000;
```

Требование XP для уровней:

| Уровень | Требуемый XP | Название фазы |
|---------|-------------|---------------|
| 1-100 | 100 * уровень^1.5 | Экспоненциальная |
| 100 | 100,000 | - |
| 101-1000 | 100K + 10K × (уровень - 100) | Мягкий cap (линейный) |
| 200 | 1.1M | - |
| 300 | 2.1M | - |
| 1000 | 10M | - |
| 1001-2000 | 10M + 150K × (уровень - 1000) | Жёсткий cap (линейный) |
| 2000 | 160M | - |
| 2000+ | Квадратичный рост | Очень жёсткий |

**Проблема 1: Первые 100 уровней очень дёшевые**

Уровень 1 требует 100 XP, уровень 100 требует 100K XP. Это только 1000x увеличение на 100 уровней.

С офлайном (216M XP за ночь), игрок может буквально в один клик заскочить на уровень 2000+.

**Проблема 2: Soft cap на уровне 100 линейный**

После уровня 100 требование XP растёт линейно (+10K за уровень), а не экспоненциально. Это создаёт "плато" где множители множительно влияют на скорость прогрессии.

**Проблема 3: Квадратичный рост слишком поздно начинается**

Квадратичный рост начинается только на уровне 2000, что слишком поздно для баланса.

**ВЫВОД:** Система уровней не готова к огромным источникам XP (офлайн, достижения, престиж).

---

## 3. КАЛЬКУЛЯЦИЯ СОВОКУПНОГО ЭФФЕКТА

Теперь сложим всё вместе:

**Сценарий:** Игрок с 5 престижами (mult = 16x) и всеми достижениями (mult = 2.36x) не входит в приложение 12 часов.

**Расчёты:**

1. **Пассивный доход за 12 часов:**
   - Базовый доход: ~100K энергии/сек (примерный, зависит от инвентаря)
   - 12 часов = 43,200 сек
   - Офлайн множитель: 0.5x
   - **Офлайн энергия = 100K × 43,200 × 0.5 = 2.16e9**

2. **Применение множителей:**
   - Престиж: 16x
   - Достижения: 2.36x
   - **Итого: 2.16e9 × 16 × 2.36 = 81.6e9 энергии**

3. **Конвертация в XP:**
   - **XP = 81.6e9 / 10 = 8.16e9 XP** (8.16 миллиардов XP за ночь!)

4. **Влияние на уровень:**
   - На уровне 100, требуется 100K XP для уровня
   - На уровне 500, требуется 500K XP для уровня
   - **8.16e9 / 500K = 16,320 уровней за ночь!**

Даже если расчёты консервативны на 10x, это всё равно **1,600+ уровней за ночь**, что соответствует жалобе игрока на 782 уровня.

---

## 4. ДОПОЛНИТЕЛЬНЫЕ ПРОБЛЕМЫ

### 4.1 Синхронизация достижений при открытии профиля

**Файл:** `backend/src/services/AchievementService.ts`

```typescript
async syncMetric(userId, metric, progressValue, client) {
  const definitions = await listDefinitionsByMetric(metric, client);

  for (const def of definitions) {
    const highestUnlocked = computeHighestUnlocked(def, progressValue);
    const previousUnlocked = existing?.highestUnlockedTier ?? 0;

    if (highestUnlocked > previousUnlocked) {
      for (let tier = previousUnlocked + 1; tier <= highestUnlocked; tier += 1) {
        // Логирование разблокировки
        await logEvent(userId, 'achievement_unlocked', {...});
      }
    }
  }
}
```

**Проблема:** Если игрок открыл приложение и прогрессия достигла 1e15 (достаточно для разблокировки всех уровней Energy Tycoon), система может одновременно:
1. Разблокировать tier 2, 3, 4, 5
2. Заклеймить все эти уровни
3. Применить множители ко всем следующим источникам XP

Это может произойти в **одном сетевом запросе**, что объясняет "мгновенный скачок уровней" при открытии приложения.

### 4.2 Множители не имеют верхнего ограничения

- Престиж-множитель может быть 1.0, 2.0, 3.0, ..., 1000+
- Достижения-множитель может быть 1.0, затем произвольный (если добавить новые достижения)
- Нет механизма, который говорит "максимум 10x множитель"

### 4.3 Cap на транзакции применяется ПОСЛЕ конвертации энергии→XP

```typescript
function computeWithCap(rawXp: number, level: number): TransactionXpComputation {
  const diminished = Math.floor(rawXp * diminishingMultiplier(level));
  const cap = transactionXpCap(level);
  const applied = cap > 0 ? Math.min(diminished, cap) : Math.max(0, diminished);
  return { appliedXp: applied };
}
```

Это означает, что cap лимитирует XP от **одной покупки**, но не от офлайна или пассивного дохода.

### 4.4 Офлайн-доход не может быть кэшеван/пересчитан сервером

Если игрок открыл приложение с неправильным временем (например, часы на телефоне неправильные), сервер всё равно считает это как офлайн-доход:

```typescript
const offlineSecondsRaw = secondsBetween(progress.lastLogout, now);  // Может быть огромным
const offlineSeconds = Math.min(offlineSecondsRaw, maxOfflineSeconds);  // Макс 12 часов
```

Нет защиты от манипуляции временем на клиенте.

---

## 5. СРАВНЕНИЕ С BEST PRACTICES ИНДУСТРИИ

### 5.1 Авторитетные источники по дизайну idle games

На основе исследований Kongregate, Game Developer и других авторитетных источников по дизайну idle games:

**Лучшие практики для престиж-систем:**

1. **Престиж должен быть редким событием**
   - Цель: игрок достигает престижа примерно 1 раз в неделю (максимум)
   - В нашем коде: Первый престиж может быть достигнут за часы/дни

2. **Множители должны иметь верхний cap**
   - Рекомендация: Максимум 10-50x множитель
   - В нашем коде: Множители могут быть 100x+

3. **Офлайн-доход должен быть значительно меньше онлайн-дохода**
   - Рекомендация: 10-25% от активного дохода за то же время
   - В нашем коде: 50% + множители = потенциально 100%+ за ночь

4. **XP требования должны расти экспоненциально на всех уровнях**
   - Рекомендация: Использовать экспоненциальную функцию везде
   - В нашем коде: Линейный рост после уровня 100 (soft cap)

5. **Источники XP не должны быть "бесплатными" на ранних уровнях**
   - Рекомендация: Cap XP от всех источников на 10-20% от порога уровня
   - В нашем коде: Cap 40% на уровне <100

6. **Множители должны быть прозрачны игроку**
   - Рекомендация: Показать общий множитель в UI
   - В нашем коде: Игрок не видит, что ему дано 82x множитель

**Примеры из известных idle games:**

- **Cookie Clicker (Orteil):** Престиж значительно труднее достичь каждый раз, множители хорошо сбалансированы
- **Incremental Games (общий тренд):** Soft caps и hard caps на множители, чтобы предотвратить инфляцию
- **Idle Champions:** Несколько раз переделывали систему престижа из-за "over-tuned scaling"

---

## 6. ПРЯМЫЕ ПРИЧИНЫ СКАЧКА НА 782 УРОВНЯ

1. **Офлайн-доход с множителями:** За 12 часов сгенерировалось 8+ миллиардов XP
2. **Система уровней не готова к такому объёму:** После уровня 100 растёт линейно, не экспоненциально
3. **Множители складываются экспоненциально:** prestige × achievement × boosts = 50x+ множитель
4. **Синхронизация достижений при открытии приложения:** Может разблокировать несколько уровней одновременно
5. **Cap на транзакции не применяется к офлайну:** Офлайн-доход не ограничен cap'ом

---

## 7. ТАБЛИЦА КРИТИЧЕСКИХ ПАРАМЕТРОВ ДЛЯ ПЕРЕСМОТРА

| Параметр | Текущее значение | Проблема | Рекомендуемое значение |
|----------|-----------------|---------|----------------------|
| `maxOfflineHours` | 12 | Слишком много | 2-4 часа |
| `offlineIncomeMultiplier` | 0.5 | Слишком много + множители | 0.1-0.2 (без множителей) |
| Офлайн-множители | Применяются полностью | Экспоненциальный рост | Не применять к офлайну |
| Cap на транзакции | 40% на уровне <100 | Слишком высокий | 10-15% |
| Престиж cap | Не ограничен | Бесконечный рост | Максимум 20x после всех престижей |
| Достижения cap | Не ограничен | Бесконечный рост | Максимум 2.0x общий множитель |
| Уровни 100+ | Линейный рост | Недостаточно | Экспоненциальный или квадратичный |
| `DIMINISH_LEVEL_BASE` | 400 | Слишком высоко | 50-100 |
| `BASE_EXPONENT` в level.ts | 1.5 | Слишком низкий | 2.0+ для более быстрого роста |

---

## 8. ЛОГИРОВАНИЕ И ОТСЛЕЖИВАНИЕ ПРОБЛЕМЫ

Для дальнейшего анализа, необходимо логировать:

```typescript
// В каждом источнике XP логировать:
await logEvent(userId, 'xp_source_name', {
  raw_energy: energyValue,
  multiplier_breakdown: {
    boost: boostMult,
    prestige: prestigeMult,
    achievement: achievementMult,
  },
  total_multiplier: totalMult,
  xp_gained: xpGained,
  current_level_before: levelBefore,
  current_level_after: levelAfter,
  level_ups_count: levelAfter - levelBefore,
});
```

Затем можно построить граф: "какой источник XP вносит больше всего вклада в прогрессию за неделю?"

---

## 9. ГИПОТЕЗЫ ДЛЯ ДАЛЬНЕЙШЕГО ТЕСТИРОВАНИЯ

1. **H1:** Офлайн-доход с множителями является основной причиной (70% вероятность)
2. **H2:** Синхронизация достижений при открытии профиля может дать 5-10% скачка уровней (40% вероятность)
3. **H3:** Покупка дорогих зданий дает значительный XP spike (50% вероятность)
4. **H4:** Множители престижа экспоненциально растут после 5+ престижей (95% вероятность)
5. **H5:** Игрок с полными достижениями получает 2-3x множитель в дополнение к престижу (95% вероятность)

---

## 10. ЗАКЛЮЧЕНИЕ

Система XP в Energy Planet имеет **критические проблемы с балансом**, которые делают прогрессию нелинейной и непредсказуемой.

Основная проблема заключается в **экспоненциальном росте множителей** (престиж × достижения × офлайн × boosts), которые применяются ко всем источникам XP без верхнего ограничения.

Требуется **комплексный рефакторинг** системы расчёта XP с фокусом на:
1. Ограничение офлайн-дохода
2. Введение верхнего cap'а на множители
3. Пересчёт требований XP для уровней
4. Более мягкое затухание XP на ранних уровнях

Без этих изменений игра будет казаться "сломанной" для новых игроков, которые внезапно скачут на уровень 700+ за ночь.

