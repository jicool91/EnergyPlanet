# Best Practices для Балансировки Idle/Clicker Games
## Руководство на основе индустриальных стандартов

**Составлено на основе:** Game Developer Magazine, Kongregate, Machinations.io, Cookie Clicker, Idle Champions
**Дата:** Октябрь 2025
**Цель:** Служить справочником для проектов подобных Energy Planet

---

## 1. АРХИТЕКТУРА СИСТЕМЫ ПРОГРЕССИИ

### 1.1 Уровень как основная метрика прогрессии

**Принцип:** Уровень должен быть одна из наиболее сложных метрик в игре, требующей максимального XP.

**Рекомендуемая структура:**

```
Уровень ←── XP (основная валюта прогрессии)
                ├── Тапы
                ├── Пассивный доход
                ├── Офлайн доход
                ├── Квесты
                └── События

Уровень → Множитель к энергии → Более быстрое накопление энергии → Быстрее прогресс
```

**Цель:** Создать "положительный feedback loop", но не экспоненциальный.

---

### 1.2 Экспоненциальная формула для требований XP

**Принцип:** XP требования должны расти экспоненциально на ВСЕХ уровнях, чтобы создать естественный "тормоз" на прогрессию.

**Рекомендуемая формула:**

```typescript
// Используй одну из этих формул:

// Option 1: Классическая экспоненциальная (как Cookie Clicker)
xpForLevel(level) = baseXp * (exponentBase ^ (level - 1))
// Примеры параметров:
// baseXp = 100, exponentBase = 1.15 (15% увеличение за уровень)
// Level 1: 100 XP
// Level 50: 1,050,000 XP
// Level 100: 11 миллионов XP

// Option 2: Полиномиальная (плавнее)
xpForLevel(level) = A + B*level + C*level^2 + D*level^3
// Примеры параметров:
// A=100, B=50, C=10, D=0.1
// Level 1: 161 XP
// Level 50: 15,650 XP
// Level 100: 60,100 XP

// Option 3: Логарифмическая (как в некоторых RPGs)
xpForLevel(level) = baseXp * log(level + 1) * coefficient
// Менее рекомендуется для idle games
```

**Почему экспоненциальная лучше:**
- Предотвращает инфляцию XP на ранних уровнях
- Создает естественное "потолок" прогрессии
- Игроки с множителями всё равно будут прогрессировать, но медленнее
- Работает со всеми уровнями, нет "plateaus"

**Что избежать:**
- ❌ Линейный рост (xpForLevel = baseXp × level)
- ❌ Soft caps с внезапными переходами
- ❌ Квадратичный рост только на высоких уровнях

---

### 1.3 Фазы прогрессии (Фаза-система)

**Принцип:** Разделить игру на несколько фаз, где каждая фаза имеет свой "сценарий" прогрессии.

**Рекомендуемая структура:**

```
Фаза 1: Уровни 1-50 (Early Game - 2-3 часа)
├─ Цель: Научить игрока основам
├─ Множители: ×1.0 (без множителей)
├─ XP требования: 100 × 1.12^level
└─ Особенность: Нет офлайн-дохода, простые механики

Фаза 2: Уровни 51-200 (Mid Game - неделя)
├─ Цель: Открыть новые здания и механики
├─ Множители: Начинают работать (×1.0-×5.0)
├─ XP требования: 100 × 1.12^level (продолжение)
└─ Особенность: Офлайн-доход 10%, достижения начинаются

Фаза 3: Уровни 201-1000 (Late Game - месяцы)
├─ Цель: Новый контент, престиж, арена
├─ Множители: Сильные (×5.0-×50.0)
├─ XP требования: 100 × 1.15^level (более крутой рост)
└─ Особенность: Полный доступ к механикам

Фаза 4: Уровни 1001+ (End Game - длительная)
├─ Цель: Сбалансированная прогрессия
├─ Множители: Кап на ×100.0
├─ XP требования: 100 × 1.20^level (очень крутой рост)
└─ Особенность: Новые ивенты,限制 на множители
```

**Преимущества:**
- Легко балансировать каждую фазу отдельно
- Понятно, где находится игрок в прогрессии
- Можно добавлять контент по фазам
- Легче обнаружить проблемы баланса

---

## 2. МНОЖИТЕЛИ И УСИЛИТЕЛИ

### 2.1 Принципы применения множителей

**Золотое правило:** Множители должны составлять **максимум 10-50x** от базового значения в конце фазы 2.

**Структура множителей:**

```
Общий множитель = base × prestige × achievement × boost × daily_bonus
                           ↓           ↓         ↓       ↓
                     (0-20x)     (1.0-3.0x)  (1.0-5x) (1.0-2x)
                     ↓
                   MAX: 50x (в нормальной игре)
                   MAX: 100x (в позднем game-e с кеппингом)
```

**Каждый множитель должен быть:**
- ✅ Визуально очевидным (UI показывает текущий множитель)
- ✅ Ограниченным (есть максимальное значение)
- ✅ Достигаемым (игрок может понять, как получить следующий бонус)
- ✅ Награждающим (ощущается значительным, но не OP)

---

### 2.2 Множитель ПРЕСТИЖА

**Best Practice:**

```typescript
// ВАРИАНТ 1: Корневая функция (как Cookie Clicker, но с капом)
prestige_multiplier = Math.pow(energySincePrevious / MILESTONE, 1/3)
Cap: prestige_multiplier ≤ 20

// ВАРИАНТ 2: Логарифмическая (более мягкая)
prestige_multiplier = 1 + log(energySincePrevious / MILESTONE) * 5
Cap: prestige_multiplier ≤ 15

// ВАРИАНТ 3: Линейная с замедлением (самая контролируемая)
prestige_multiplier = 1 + (energySincePrevious / MILESTONE) * 3
Cap: prestige_multiplier ≤ 20
```

**Параметры для настройки:**

| Параметр | Best Practice | Текущее (EP) | Проблема |
|----------|---------------|-------------|---------|
| PRESTIGE_MILESTONE | 1e12 (1 день hard play) | 1e12 | ✓ OK |
| Cap на множитель | 20 | ∞ | ❌ Нет cap |
| Частота престижа | Примерно 1-2 в неделю | Может быть в день | ❌ Слишком часто |
| Сброс прогрессии | Все, кроме множителя | ✓ Правильно | ✓ OK |

**Что избежать:**
- ❌ Неограниченный множитель (может быть 1000x)
- ❌ Слишком частые престижи (каждый день)
- ❌ Множители, которые применяются ко ВСЕМ источникам XP

---

### 2.3 Множитель ДОСТИЖЕНИЙ

**Best Practice:**

```typescript
// Каждое достижение имеет многоуровневую систему:
achievement_multiplier = 1.0  // Начальное значение

// Каждый уровень добавляет МАЛЫЙ бонус:
tier_1: ×1.05  (5% бонус)
tier_2: ×1.08  (8% бонус)
tier_3: ×1.10  (10% бонус)
tier_4: ×1.12  (12% бонус)
tier_5: ×1.15  (15% бонус)

// Общий множитель = 1.05 × 1.08 × 1.10 × 1.12 × 1.15 ≈ 1.70

// Макс количество достижений = 10-15
// Общий cap на достижения = 1.70 ^ N, где N ≤ 3.0 (MAX)
```

**Параметры для настройки:**

| Параметр | Best Practice | Текущее (EP) | Проблема |
|----------|---------------|-------------|---------|
| Бонус за уровень | 5-15% (маленькие) | 1-10% (разные) | ⚠️ Неоптимально |
| Cap на уровень | 5 уровней | 5 уровней | ✓ OK |
| Общий cap | 2.0-3.0x | ∞ | ❌ Нет cap |
| Разблокировка | Постепенная | Может быть много одновременно | ⚠️ Нужна синхро |
| UI показывает cap | Да | Нет | ❌ Нужен UI |

**Механика разблокировки:**

```typescript
// Правильно: разблокировка видна, но требует активации
- Игрок видит "достижение готово к клейму"
- Нажимает кнопку, получает бонус
- UI обновляется с новым множителем
- Это занимает 2 сетевых запроса (защита от спама)

// Неправильно: автоматическая разблокировка
- При открытии профиля внезапно разблокируется несколько уровней
- Множитель скачивает на 3x за раз
- Игрок видит в одно мгновение перемену в прогрессии
```

---

### 2.4 Множитель АКТИВНЫХ БУСТОВ

**Best Practice:**

```typescript
// Активные бусты должны быть временные (не вечные)
boost_multiplier = 1.0  // Начальное

// Примеры бустов:
short_term (10 минут): ×1.5 (50% бонус)
medium_term (1 час): ×2.0 (100% бонус)
long_term (8 часов): ×1.2 (20% бонус)

// Ограничения:
- Одновременно макс 3 активных буста
- Макс множитель всех вместе = ×5.0
- Нельзя "стакать" одинаковые бусты

// Проверка на клиенте:
if (currentBoosts.length >= 3) {
  return "Максимум 3 активных буста";
}
```

**Параметры для настройки:**

| Параметр | Best Practice | Текущее (EP) | Проблема |
|----------|---------------|-------------|---------|
| Макс активные | 3 | ? | ? |
| Макс множитель | 5.0 | ? | ? |
| Длительность | 10мин-8часов | ? | ? |
| Разрешить стак | Нет | ? | ? |

---

## 3. ОФЛАЙН ДОХОД

### 3.1 Принципы офлайн-дохода

**Золотое правило:** Офлайн-доход должен быть **значительно меньше** онлайн-дохода за то же время, чтобы поощрять активность.

**Рекомендуемые значения:**

```
Офлайн множитель = 15-25% от пассивного дохода (без других множителей)
Макс офлайн время = 2-4 часа

// Пример:
Пассивный доход = 100K энергии/сек
2 часа активно = 100K × 7200 = 720M энергии
2 часа офлайна = 100K × 7200 × 0.2 = 144M энергии (20% от активного)
```

**КРИТИЧНО:** Офлайн доход **не должен применять** множители prestige/achievement!

```typescript
// ❌ НЕПРАВИЛЬНО
offlineEnergy = baseIncome × offlineSeconds × 0.5 × prestige × achievement
// Это позволяет офлайну дать 100x+ прирост

// ✅ ПРАВИЛЬНО
offlineEnergy = baseIncome × offlineSeconds × 0.2  // БЕЗ множителей
// Офлайн дает 20% от базового дохода, точка
```

**Параметры для настройки:**

| Параметр | Best Practice | Текущее (EP) | Проблема |
|----------|---------------|-------------|---------|
| Офлайн множитель | 0.15-0.25 | 0.5 | ❌ Слишком высокий |
| Макс офлайн часов | 2-4 | 12 | ❌ Слишком много |
| Применять prestige | Нет | Да | ❌ Критичная ошибка |
| Применять achievement | Нет | Да | ❌ Критичная ошибка |
| Применять boosts | Нет | Да | ❌ Критичная ошибка |

---

### 3.2 Варианты защиты от манипуляции временем

**Проблема:** Клиент может сказать серверу неправильное время, чтобы получить больше офлайн-дохода.

**Решение 1: Доверять только серверу**

```typescript
// На сервере:
const offlineSeconds = Math.floor((now - lastLogin) / 1000);  // Серверное время!
const maxOfflineSeconds = 4 * 3600;  // 4 часа
const accountedSeconds = Math.min(offlineSeconds, maxOfflineSeconds);

// Клиент может сказать что угодно, сервер проверяет дату в БД
```

**Решение 2: Цепь блокчейна (для очень важного контента)**

```typescript
// Не рекомендуется для casual games, слишком сложно
```

**Решение 3: Client + Server check**

```typescript
// Клиент отправляет: clientDelta (сколько времени прошло на клиенте)
// Сервер проверяет:
const serverDelta = now - lastLogin;  // Серверное время
const discrepancy = Math.abs(clientDelta - serverDelta);

if (discrepancy > 60) {  // Больше чем на 1 минуту
  // Использовать серверное значение, логировать подозрение
  const realDelta = serverDelta;
} else {
  const realDelta = clientDelta;  // Клиент честный
}
```

---

## 4. XP ТРАНЗАКЦИИ (Покупки, квесты и т.д.)

### 4.1 XP от покупок зданий

**Принцип:** Покупка дорогого здания должна дать значительный, но **не переломный** приход XP.

**Рекомендуемая формула:**

```typescript
// Базовый XP от покупки:
baseXp = Math.pow(buildingCost, 0.6) * coefficient

// Коэффициент = рассчитать так, чтобы:
// - Здание стоимостью 1M дало ~10K XP на уровне 50
// - Здание стоимостью 1T дало ~100M XP на уровне 500

// Затем применить cap (важно!):
xpWithCap = Math.min(baseXp, xpThresholdForLevel(currentLevel) * 0.10)
// MAX 10% от требуемого XP для уровня

// НИКОГДА не применять множители (prestige/achievement) к покупкам:
appliedXp = xpWithCap  // БЕЗ множителей!
```

**Параметры для настройки:**

| Параметр | Best Practice | Текущее (EP) | Проблема |
|----------|---------------|-------------|---------|
| Экспонента | 0.6-0.7 | 0.75 | ⚠️ Немного высокая |
| Cap процент | 10% от уровня | 40% | ❌ Слишком высокий |
| Применять mult | Нет | Да | ❌ Ошибка |
| Затухание | Да, с DIMINISH | Да | ✓ OK |

---

### 4.2 Cap система для транзакций

**Проблема:** Без cap'а, одна большая покупка может дать целый уровень.

**Best Practice:**

```typescript
// Переходящий cap в зависимости от уровня:

function transactionCapPercent(level) {
  if (level < 50) return 0.05;      // 5% (защита новичков)
  if (level < 100) return 0.08;     // 8%
  if (level < 300) return 0.12;     // 12%
  if (level < 1000) return 0.15;    // 15%
  return 0.20;                       // 20% (макс)
}

// Применение cap:
xpThreshold = xpRequiredForLevel(level);
capAmount = Math.floor(xpThreshold * transactionCapPercent(level));
appliedXp = Math.min(rawXp, capAmount);
```

**Почему такие маленькие проценты:**
- Защищает новичков от инфляции XP через покупки
- Поощряет разнообразие источников XP (тапы, офлайн, квесты)
- Создает "долгосрочную" прогрессию

---

## 5. СИСТЕМА УРОВНЕЙ - ПРИМЕРЫ ХОРОШИХ ФОРМУЛ

### 5.1 Классическая экспоненциальная (Cookie Clicker style)

```typescript
const BASE_XP = 100;
const EXPONENT_BASE = 1.15;  // 15% увеличение за уровень

export function xpForLevel(level) {
  return Math.round(BASE_XP * Math.pow(EXPONENT_BASE, level - 1));
}

// Результаты:
// Level 1: 100
// Level 10: 405
// Level 50: 1.76M
// Level 100: 31.4M
// Level 200: 9.87T
```

**Преимущества:**
- ✅ Простая формула, легко считать
- ✅ Экспоненциальный рост везде
- ✅ Естественный "потолок" на прогрессию
- ✅ Легко добавлять фазы (меняя EXPONENT_BASE)

**Недостатки:**
- ❌ На очень высоких уровнях может быть очень крутой рост
- ❌ Числа становятся астрономическими (бить с float precision)

---

### 5.2 Полиномиальная (более плавная)

```typescript
// Piecewise polynomial
export function xpForLevel(level) {
  if (level <= 100) {
    // Экспоненциальная в начале
    return Math.round(100 * Math.pow(1.12, level - 1));
  } else if (level <= 500) {
    // Полиномиальная в середине
    const base = 100 * Math.pow(1.12, 99);  // XP на уровне 100
    return Math.round(base + (level - 100) * (level - 100) * 1000);
  } else {
    // Кубическая на высоких уровнях
    const base = xpForLevel(500);
    return Math.round(base + Math.pow(level - 500, 3) * 100);
  }
}
```

**Преимущества:**
- ✅ Плавный переход между фазами
- ✅ Контролируемый рост
- ✅ Легко настраивать по фазам

**Недостатки:**
- ❌ Сложнее в коде
- ❌ Нужна калибровка каждой фазы

---

## 6. ДОСТИЖЕНИЯ И МЕТРИКИ

### 6.1 Какие метрики отслеживать

**Best Practice:** Отслеживать метрики, которые стимулируют здоровый gameplay.

```typescript
// ✅ ХОРОШИЕ метрики для достижений:
- total_energy_produced (поощряет игру в целом)
- total_taps (поощряет активность)
- buildings_count (поощряет разнообразие в стратегии)
- prestige_level (поощряет долгосрочную игру)
- days_played (поощряет регулярность)
- events_completed (поощряет ивенты)
- upgrades_purchased (поощряет экономику)

// ❌ ПЛОХИЕ метрики для достижений:
- levels_gained (создает feedback loop с XP)
- offline_income (стимулирует неактивность)
- boosts_used (может быть P2W)
```

### 6.2 Структура достижений

**Best Practice:**

```typescript
Interface Achievement {
  id: string;
  name: string;
  description: string;
  metric: string;              // total_energy, total_taps и т.д.

  tiers: [
    { tier: 1, threshold: 1e5, rewardMultiplier: 1.05 },
    { tier: 2, threshold: 1e7, rewardMultiplier: 1.08 },
    { tier: 3, threshold: 1e9, rewardMultiplier: 1.10 },
    { tier: 4, threshold: 1e12, rewardMultiplier: 1.12 },
    { tier: 5, threshold: 1e15, rewardMultiplier: 1.15 },
  ];

  cosmetics: [  // Опциональные награды
    { tier: 2, cosmeticId: 'cool_skin' },
    { tier: 4, cosmeticId: 'cool_frame' },
  ];
}
```

**Параметры:**

| Параметр | Best Practice | Рекомендация |
|----------|---------------|-------------|
| Макс уровней | 5-10 | Не больше 10 |
| Бонус за уровень | 5-15% | Маленькие, частые |
| Макс достижений | 15-25 | Не переборчиво |
| Новые достижения | Добавлять редко | 1-2 в сезон |
| Синхронизация | Только при нужде | Не на каждый вход |

---

## 7. МОНИТОРИНГ И АНАЛИТИКА

### 7.1 Метрики для отслеживания баланса

```typescript
// Каждый день собирать эту информацию:

interface BalanceMetrics {
  // Прогрессия
  average_level: number;
  median_level: number;
  level_distribution: Map<number, number>;  // Сколько игроков на каждом уровне

  // Скорость прогрессии
  xp_per_day: number;
  levels_per_day: number;
  prestige_frequency: "hours" | "days" | "weeks";

  // Множители
  average_prestige_multiplier: number;
  average_achievement_multiplier: number;
  average_total_multiplier: number;

  // Источники XP
  xp_from_offline: number;      // % от всего XP
  xp_from_taps: number;
  xp_from_passive: number;
  xp_from_quests: number;
  xp_from_purchases: number;

  // Проблемы
  level_gaps: number;            // Игроки, которые внезапно скачат на 100+ уровней
  suspicious_activity_count: number;
}
```

### 7.2 Рекомендуемые thresholds для алертов

```typescript
if (metrics.average_prestige_multiplier > 50) {
  alert("⚠️ Престиж множитель слишком высокий");
}

if (metrics.xp_from_offline > 0.30) {  // Больше 30% XP от офлайна
  alert("⚠️ Офлайн доход слишком щедрый");
}

if (metrics.levels_per_day > 10) {
  alert("⚠️ Прогрессия слишком быстрая");
}

if (metrics.level_gaps.count > 0.05 * playerCount) {  // 5% игроков со скачками
  alert("⚠️ Обнаружено аномальное увеличение уровней");
}
```

---

## 8. ИТОГОВЫЙ ЧЕКЛИСТ ДЛЯ БАЛАНСИРОВКИ

```
ПРЕЖДЕ ЧЕМ запустить game in production:

□ Система уровней использует экспоненциальный рост везде
□ XP требования на 100+ уровне НЕ переходят на линейный
□ Офлайн множитель ≤ 0.25 (25%) БЕЗ других множителей
□ Офлайн время ≤ 4 часов
□ Престиж множитель имеет cap ≤ 20
□ Достижения множитель имеет cap ≤ 3.0
□ Покупки дают ≤ 15% от требуемого XP для уровня
□ Множители НЕ применяются к офлайн-доходу
□ Синхронизация достижений делается без спама
□ UI показывает текущий общий множитель
□ Логируется каждый источник XP с множителями
□ Есть аналитика по скорости прогрессии (за день/неделю/месяц)
□ Есть защита от манипуляции временем на клиенте
□ Тестирование баланса на разных уровнях (1, 50, 100, 500, 1000)
□ Документация формул в README для новых разработчиков
```

---

## 9. ИНСТРУМЕНТЫ ДЛЯ ТЕСТИРОВАНИЯ

### 9.1 Симуляция прогрессии

```python
# Python скрипт для симуляции:

def simulate_progression(days_played, daily_active_hours, prestige_level):
  xp = 0
  level = 1

  for day in range(days_played):
    # Дневной XP от активности
    daily_xp = (active_hours * 3600 * passive_income) / 10
    daily_xp *= (1 + prestige_level * 0.5)

    # Ночной офлайн XP (no multipliers!)
    offline_hours = min(24 - active_hours, 4)  // Max 4 hours
    offline_xp = (offline_hours * 3600 * passive_income * 0.2) / 10

    xp += daily_xp + offline_xp

    # Расчет уровня
    while xp >= xp_required_for_level(level):
      xp -= xp_required_for_level(level)
      level += 1

  return level

# Запуск симуляции:
for days in [1, 7, 30, 365]:
  level = simulate_progression(days_played=days, daily_active=3, prestige=5)
  print(f"После {days} дней: Level {level}")

# Ожидаемые результаты (approximate):
# После 1 дня: Level 5-10
# После 7 дней: Level 30-50
# После 30 дней: Level 100-150
// После 365 дней: Level 500-1000
```

### 9.2 Regression тесты

```typescript
describe("Progression Balance", () => {
  it("should not jump more than 10 levels overnight", () => {
    const player = createTestPlayer({ level: 50, prestige: 3 });
    const offlineGains = simulateOffline(12 * 3600);  // 12 hours
    expect(offlineGains.levelUp).toBeLessThan(10);
  });

  it("single building purchase should not exceed 15% of level XP", () => {
    const expensiveBuilding = { cost: 1e12 };
    const xpGain = calculatePurchaseXp(expensiveBuilding.cost, 100);
    const levelThreshold = xpRequiredForLevel(100);
    expect(xpGain).toBeLessThan(levelThreshold * 0.15);
  });

  it("prestige multiplier should cap at 20", () => {
    const player = createTestPlayer({ prestige: 1000 });
    expect(player.prestigeMultiplier).toBeLessThanOrEqual(20);
  });
});
```

---

## 10. ЗАКЛЮЧЕНИЕ

Балансировка idle games - это **интеграция множественных систем**, которые должны работать гармонично.

**Ключевые выводы:**

1. **Экспоненциальный рост везде** - предотвращает инфляцию
2. **Множители с кепингом** - предотвращает feedback loops
3. **Офлайн ограничен** - поощряет активность
4. **Синхронизация осторожна** - избегает surprise скачков
5. **Аналитика постоянна** - следите за метриками
6. **Тестирование обязательно** - перед релизом и после

Игра должна быть **предсказуемой** для игроков. Если игрок видит внезапный скачок на 700 уровней за ночь, это признак серьёзного дисбаланса.

