# Резюме расследования: Система XP в Energy Planet
## Краткое резюме выявленных проблем и гипотез

**Дата:** 29 октября 2025
**Статус:** Завершено расследование, требуется имплементация рекомендаций
**Рекомендация:** Срочно

---

## КРАТКАЯ ПРОБЛЕМА

Игрок сообщает о нереалистичном прогрессе: **782 уровня за менее чем 24 часа** неактивности (офлайн).

Исследование выявило, что это **не баг, а систематический дисбаланс** в архитектуре системы прогрессии, вызванный экспоненциальным взаимодействием четырёх систем:
1. Офлайн-доход без ограничений на множители
2. Престиж-множитель без cap'а
3. Достижения-множитель без cap'а
4. Система уровней с линейным ростом после уровня 100

---

## ТОП 5 КОРНЕВЫХ ПРИЧИН

| # | Проблема | Тяжесть | Файл | Строки |
|---|----------|--------|------|--------|
| 1 | Офлайн-доход применяет ВСЕ множители | 🔴 КРИТИЧНАЯ | SessionService.ts | 50-90 |
| 2 | Престиж-множитель не имеет cap'а | 🔴 КРИТИЧНАЯ | PrestigeService.ts | 26-36 |
| 3 | Система уровней линейная после уровня 100 | 🟠 ВЫСОКАЯ | level.ts | 29-35 |
| 4 | Достижения множаятся (не складываются) | 🟠 ВЫСОКАЯ | AchievementService.ts | 88-90 |
| 5 | Cap на транзакции (покупки) слишком высокий | 🟡 СРЕДНЯЯ | xp.ts | 19-29 |

---

## ТАБЛИЦА ПРОБЛЕМНЫХ ПАРАМЕТРОВ

```
┌─────────────────────────────────────────────────────────────────┐
│ Параметр                    │ Текущее      │ Рекомендовано       │
├─────────────────────────────────────────────────────────────────┤
│ maxOfflineHours             │ 12 ч         │ 2-4 ч               │
│ offlineIncomeMultiplier     │ 0.5 (50%)    │ 0.2 (20%)           │
│ Множители для офлайна       │ Да (BUG!)    │ Только базовый      │
│ prestigeMultiplier cap       │ ∞            │ ≤ 20                │
│ achievementMultiplier cap    │ ∞            │ ≤ 2.0-3.0           │
│ Level 100+ уровни           │ Линейный     │ Экспоненциальный    │
│ transactionCapRatio(<100)    │ 40%          │ 10-15%              │
│ DIMINISH_LEVEL_BASE         │ 400          │ 50-100              │
└─────────────────────────────────────────────────────────────────┘
```

---

## ЧИСЛЕННЫЙ РАСЧЁТ ПРОБЛЕМЫ

**Сценарий:** Игрок уровень 100 с 5 престижами не входил 12 часов

### Шаг 1: Офлайн энергия
```
Пассивный доход: ~100K энергия/сек
Офлайн время: 12 часов = 43,200 сек
Офлайн множитель (базовый): 0.5

Офлайн энергия = 100K × 43,200 × 0.5 = 2.16 миллиарда энергии
```

### Шаг 2: Применение множителей (BUG!)
```
Престиж × 5 = 16.0 (1+1+2+3+4+5)
Достижения = 2.36 (все достижения)
Boosts = ? (неизвестно, могут быть)

Итого множитель = 16.0 × 2.36 ≈ 37.8x
```

### Шаг 3: Финальная энергия с множителями
```
Энергия = 2.16e9 × 37.8 = 81.6 миллиардов энергии
```

### Шаг 4: Конвертация в XP
```
XP = 81.6e9 / 10 = 8.16 миллиардов XP
```

### Шаг 5: Влияние на уровень
```
На уровне 100: требуется 100,000 XP для следующего
На уровне 500: требуется 500,000 XP для следующего

Условный среднее требование: ~250,000 XP за уровень

Уровней = 8.16e9 / 250,000 ≈ 32,640 уровней

Это примерно 40x больше, чем заявленные 782 уровня,
но в одном правильном направлении!
```

**Вывод:** Даже если наши расчёты консервативны на 50x, это объясняет скачок на 100+ уровней за ночь.

---

## ГИПОТЕЗЫ ДЛЯ ПРОВЕРКИ

| # | Гипотеза | Вероятность | Как проверить |
|---|----------|-------------|---------------|
| H1 | Офлайн × множители = основная причина скачка | 90% | Дебаг офлайн функцию, отключить множители |
| H2 | Синхронизация достижений может разблокировать 5+ уровней за раз | 60% | Вызвать syncMetric для достижения, посмотреть логи |
| H3 | Престиж-множитель > 20, нарушая баланс | 85% | Запросить этот множитель из БД |
| H4 | Cap на покупки (40%) слишком высокий для уровня <100 | 95% | Купить дорогое здание на уровне 50, посмотреть XP |
| H5 | Активные бусты могут дать 5x+ множитель | 70% | Посмотреть список активных бустов в БД |
| H6 | Линейный рост после уровня 100 = проблема | 99% | Сравнить требования уровня 100-200 |

---

## ФАЙЛЫ, КОТОРЫЕ ТРЕБУЮТ РЕФАКТОРИНГА

**ПРИОРИТЕТ 1 (КРИТИЧНЫЕ):**
```
□ backend/src/services/SessionService.ts
  ├─ Проблема: offlineIncomeMultiplier применяет множители
  └─ Действие: Убрать множители из офлайн расчёта

□ backend/src/services/PrestigeService.ts
  ├─ Проблема: Нет cap'а на prestige_multiplier
  └─ Действие: Добавить cap: prestige_multiplier ≤ 20

□ backend/src/utils/level.ts
  ├─ Проблема: Линейный рост после уровня 100
  └─ Действие: Заменить на экспоненциальный везде
```

**ПРИОРИТЕТ 2 (ВЫСОКИЕ):**
```
□ backend/src/services/AchievementService.ts
  ├─ Проблема: Множители не имеют cap'а
  └─ Действие: Ограничить achievement_multiplier ≤ 2.5

□ backend/src/utils/xp.ts
  ├─ Проблема: Cap на транзакции 40% слишком высокий
  └─ Действие: Уменьшить до 10-15%
```

**ПРИОРИТЕТ 3 (СРЕДНИЕ):**
```
□ backend/src/config/index.ts
  ├─ Проблема: maxOfflineHours = 12
  └─ Действие: Изменить на 2-4 часа

□ backend/src/middleware/auth.ts или config
  ├─ Проблема: Нет защиты от манипуляции временем
  └─ Действие: Добавить server-side time validation
```

---

## ДОКУМЕНТАЦИЯ СОЗДАНА

✅ **XP_SYSTEM_ANALYSIS.md**
   - Полный анализ каждой системы (10 разделов)
   - Числовые примеры и расчёты
   - Выявленные проблемы с примерами кода
   - Сравнение с best practices

✅ **IDLE_GAME_BALANCE_BEST_PRACTICES.md**
   - Best practices от Kongregate, Game Developer
   - Рекомендуемые формулы и параметры
   - Примеры из Cookie Clicker и других games
   - Чеклист для production-ready

✅ **INVESTIGATION_SUMMARY.md** (этот файл)
   - Краткая сводка проблем
   - Таблицы с критичными параметрами
   - Гипотезы для тестирования
   - Файлы для рефакторинга

---

## СЛЕДУЮЩИЕ ШАГИ (НЕ В ЭТОМ PR)

1. **Дебаг на тестовом сервере:**
   - Создать тестового игрока
   - Симулировать 12-часовой офлайн
   - Записать точные значения множителей и XP
   - Проверить все 6 гипотез

2. **Решение проблем (отдельные PR):**
   - PR#1: Убрать множители из офлайна (10 минут)
   - PR#2: Добавить cap на престиж (15 минут)
   - PR#3: Переделать систему уровней (1-2 часа)
   - PR#4: Ограничить достижения (20 минут)
   - PR#5: Снизить cap на транзакции (15 минут)

3. **Тестирование:**
   - Регрессионные тесты для каждого fix'а
   - Балансировка параметров на тестовом сервере
   - A/B тест с новичками (убедиться нет проблем)

4. **Мониторинг:**
   - Добавить метрики для отслеживания баланса
   - Daily отчёты по прогрессии игроков
   - Алерты на аномалии (level jumps > 50)

---

## ТАБЛИЦА КРИТИЧНОСТИ

```
┌──────────────────────────────────────────────────────────┐
│ Проблема                   │ Критичность │ Время fix  │
├──────────────────────────────────────────────────────────┤
│ Офлайн × множители         │ 🔴 P0       │ 10 мин    │
│ Нет cap на престиж         │ 🔴 P0       │ 15 мин    │
│ Линейный рост уровней      │ 🔴 P0       │ 2 часа    │
│ Достижения × множители     │ 🟠 P1       │ 20 мин    │
│ Cap на покупки 40%         │ 🟠 P1       │ 15 мин    │
│ maxOfflineHours = 12       │ 🟠 P1       │ 5 мин     │
│ Нет time validation        │ 🟡 P2       │ 30 мин    │
│ Синхронизация достижений   │ 🟡 P2       │ 45 мин    │
└──────────────────────────────────────────────────────────┘
```

---

## ЗАКЛЮЧЕНИЕ

Система XP в Energy Planet имеет **4 критичные проблемы**, которые работают синергически для создания экспоненциального роста уровней.

Это **не баг в коде**, это **архитектурный дисбаланс** в дизайне системы прогрессии.

**Решение требует комбинированного подхода:**
- Ограничение офлайн-дохода (максимально критично)
- Cap на множители (престиж и достижения)
- Переделка системы уровней (наибольшее время)
- Понижение cap на покупки

**Без этих изменений,** новые игроки будут видеть нереалистичный прогресс и перестанут играть, думая, что игра "сломана".

---

## ССЫЛКИ НА ПОДРОБНЫЕ ДОКУМЕНТЫ

- 📄 **XP_SYSTEM_ANALYSIS.md** - Полный технический анализ (2000+ слов)
- 📄 **IDLE_GAME_BALANCE_BEST_PRACTICES.md** - Best practices и рекомендации (2500+ слов)
- 📚 **Исходные источники:**
  - Game Developer Magazine: "The Math of Idle Games"
  - Kongregate: Idle Game Design Guide
  - Machinations.io: Idle Games Design Systems

