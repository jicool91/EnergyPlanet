# Миграция `react` / `react-dom` 18.3.1 → 19.x

## Новое в React 19 (официальный релиз, сентябрь 2024)

- Встроенный **Actions API** (`useActionState`, `<form action>` и пр.) упрощает работу с асинхронными сабмитами.
- Новые хуки `use` и `useOptimistic`, улучшена поддержка Suspense, серверного рендеринга и переходов.
- Обновлён `react-dom` (новая стриминговая SSR, фиксы StrictMode), официально поддерживаются `createRoot` и React Compiler.
- С релизом 19 пересмотрены типы: `React.FC` больше не предоставляет `defaultProps`, появились новые `Ref` и `EventPriority` определения.

## Влияние на наш проект

- **Точка входа** (`webapp/src/main.tsx`) уже использует `ReactDOM.createRoot`, поэтому основные изменения автоматически подхватятся.
- **Хуки и Suspense**: мы активно используем `<Suspense>` для lazy-панелей. Нужно проверить, не появятся ли дополнительные «double render» в StrictMode после обновления — логика `useEffect`/`useMemo` должна быть идемпотентной.
- **Сторонние библиотеки:** 
  - `framer-motion` 10.x официально поддерживает React 18. Для React 19 нужен фреймер ≥12 (см. отдельный план миграции).
  - `react-router-dom` мы не используем, но стоит убедиться, что другие пакеты совместимы (zustand 4 → 5 поддерживает React 19).
  - ESLint-плагины (`eslint-plugin-react-hooks`, `@typescript-eslint/*`) требуют актуальных версий, иначе правила могут не понимать новые хуки.
- **Типы**: нужно обновить `@types/react` и `@types/react-dom` до 19.x и проверить кастомные декларации (например, `window._energyLogs` в `main.tsx`).

## План миграции

1. Обновить пакеты:
   ```bash
   npm install react@^19.2.0 react-dom@^19.2.0 @types/react@^19.2.2 @types/react-dom@^19.2.2
   ```
2. В `.eslintrc`/конфиге обновить `eslint-plugin-react-hooks` минимум до `7.x` (он добавляет правила для новых хуков) и синхронизировать `@typescript-eslint/*` до 8.x.
3. В коде просканировать примеры использования Suspense / lazy компонентов (`MainScreen.tsx`): убедиться, что побочные эффекты не зависят от однократного рендера (React 19 продолжает строгий двойной run в dev).
4. Пройтись по кастомным хукам (например, `useHaptic`, `useSafeArea`) и проверить возвращаемые типы — обновлённые типы React строже относятся к `undefined` в JSX.
5. Обновить фреймворк-анимации (`framer-motion`) и любые пакеты, которые завязаны на старые типы событий React.
6. Smoke-тест: загрузка lazy-панелей, Suspense fallback’и, обработчики форм (если появятся Actions, можно поэкспериментировать).

## Чек-лист

- [ ] `react` / `react-dom` и соответствующие `@types` обновлены до 19.x.
- [ ] Плагины ESLint (`react-hooks`, `@typescript-eslint`) обновлены и конфигурация проходит `npm run lint`.
- [ ] `framer-motion`, `zustand` и другие пакеты подтверждены как совместимые или обновлены.
- [ ] Ручные тесты: переключение вкладок, Suspense fallback (`ShopPanel`/`BuildingsPanel`), никаких warning’ов в консоли.
