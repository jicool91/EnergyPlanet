# Energy-to-Stamina Refactor Draft

## Goals
- Развести «выносливость для кликов» и экономические ресурсы.
- Сохранить ощущение прогресса за счёт Tap Level и мета-экономики.
- Подготовить систему для будущих анти-бот и live-ops механизмов.

## Новая терминология
- **Ста́мина (Stamina / Пульсарный заряд)**  
  - Расходуется на каждое нажатие.  
  - Восстанавливается со временем (базово 1 ед. / 12 сек → полный стак за ~1 час).  
  - Ёмкость и скорость регена растут с Tap Level и мета-перками.  
  - Обнуляется при фоновом автокликере → игроку понятно, что лучше вернуться позже.

- **Уран (Upgrade Resource)**  
  - Основное сырьё для апгрейдов планет и инфраструктуры.  
  - Добывается из тапов (через конвертацию ста́мины), квестов, сезонных наград.  
  - Может иметь «обработку»: переработка в сплавы/модули на поздних уровнях.

- **Антиматерия (Premium)**  
  - Мягкая премиум-валюта для ускорения восстановления, покупки бустеров, пропуска квестов.  
  - Источники: магазин, сезонный пропуск, редкие события.

## Цикл "Жизнь игрока"
1. **Заходит → забирает ста́мину**, проверяет запас Урана, траты/апгрейды.  
2. **Активно кликает**, тратит ста́мину; одновременно растёт Tap Level и множители.  
3. **Ста́мина кончилась → пауза**. Игрок может заняться:
   - Квестами (не тратят ста́мину, но дают Уран/Антиматерию).  
   - Мета-менеджментом (апгрейды, редкие события).  
   - Социальными активностями.
4. **Через 8–12 часов** возвращается: ста́мина полная, сезонные задания обновлены.  
5. **Повышает Tap Level / ёмкость ста́мины** → в каждой сессии больше выгоды, удержание растёт.

## Баланс (первичная гипотеза)
- Базовая ёмкость ста́мины: 300 ед. (≈ 5 мин активных тапов).  
- Пополнение: +1 ед. / 12 сек (полный стак за 60 мин).  
- Tap Level +1: +10% к ёмкости, +5% к регену.  
- Ограничение rate limiter'ов на сервере:  
  - `/tap`: поднять до ~25 req/sec (вместо 10).  
  - `/tick`: 1 req / 3 sec (вместо 1 / 8 sec).  
  - Антибот → анализ паттернов (CPS, равные интервалы, длительность сессии).

## Следующие шаги
### Backend
1. **Модели и хранение**
   - Добавить поля `stamina`, `stamina_capacity`, `stamina_regen_per_sec` в таблицу прогресса.  
   - Миграция данных: начальное значение = 300 (capacity) и 1/12 (regen).  
   - Обновить `ProgressRepository`/`TapService`/`TickService`: расходовать ста́мину, запрещать тап при нуле, отдавать новый баланс в ответах API.

2. **Регенация**
   - Добавить функцию `recalculateStamina(userId, now)` — вычисляет фактическую ста́мину по времени (на основе `stamina_updated_at`).  
   - Вызывать в `refreshSession`, `tap`, `tick`, `login`.  
   - Ограничить максимум ёмкостью; не тратить при тапе, если нет ста́мины.

3. **Endpoints**
   - Обновить ответы `/session`, `/tap`, `/tick`, `/profile` — вернуть ста́мину и свойства (capacity, regen).  
   - Ввести `/stamina/boost` (по желанию) — расходует Антиматерию на моментальные пополнения.

4. **Лимитеры**
   - Пересмотреть `tapRateLimiter` (25 req/s) и `tickRateLimiter` (1 req/3s).  
   - Ввести soft-limit на сервере: если ста́мина 0 — возвращать 403 `stamina_depleted`.

5. **Логи/телеметрия**
   - Добавить события: `stamina_depleted`, `stamina_refilled`, `stamina_boost_used`, `stamina_level_up`.

### Frontend
1. **Состояние**
   - Расширить `gameStore`: поля `stamina`, `staminaCapacity`, `staminaRegenPerSec`, время последнего обновления.  
   - При каждом `tap`/`tick` локально уменьшать ста́мину; регулярно вызывать `recalculateStaminaClient` (шагом 1 сек).

2. **UI/UX**
   - HUD: индикатор ста́мины с таймером восстановления.  
   - Диалог «Ста́мина закончилась» с CTA: вернуться позже, купить пополнение, перейти в квесты.  
   - Отображение «Tap Level» + бонусы ста́мины.

3. **API**
   - Обновить типы ответов (`/session`, `/profile`, `/tap`, `/tick`).  
   - Обработать 403 `stamina_depleted`: показать сообщение, скрыть кнопку тапа до восстановления.

4. **Переименование ресурсов**
   - `energy` (в UI) → `uranium` (Уран).  
   - Добавить отображение Антиматерии + кнопки «Пополнить ста́мину», «Ускорить реген».

### Content / Live-Ops
1. **Tap Level**
   - Пересчитать формулы уровня: увеличение ёмкости и регена; обновить отображение.  
   - Пересчитать стоимость апгрейдов (если привязаны к старой энергии).

2. **Квесты и события**
   - Обновить награды: выдавать Уран/Антиматерию.  
   - Добавить задания «Потрать ста́мину», «Вернись через X часов».

3. **Экономика**
   - Пересчитать курсы: ста́мина → Уран, Антиматерия → ста́мина (если продаём пополнения).  
   - Балансировать так, чтобы дневной цикл требовал 2–3 заходов.

### Антибот
1. Собрать метрики: CPS, разброс интервалов, длина сессии, доля тапа с нулевой ста́мине.  
2. Настроить 알ерты: аномально длинные сессии, постоянные равные интервалы, высокая доля 403 `stamina_depleted`.  
3. На основе метрик — правила: предупреждения, soft-ban, заморозка ста́мины.

### QA & Release
- Добавить интеграционные тесты `/tap` + ста́мина.  
- Написать скрипт миграции данных (обновление всех аккаунтов).  
- Подготовить план отката (старые поля энергии восстановить при необходимости).  
- Отдельный анонс и in-game туториал (что такое ста́мина, зачем паузы, как заработать Уран/Антиматерию).
